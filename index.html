<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KLC Nội bộ</title>

  <!-- UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root { --klc-yellow:#f6c90e; --klc-blue:#1f4b99; }
    body { background:#f7f9fc; }
    .klc-navbar { background: linear-gradient(90deg, var(--klc-blue), #0a2f6b); }
    .klc-navbar .navbar-brand, .klc-navbar .nav-link, .klc-navbar .navbar-text { color:#fff !important; }
    .card { border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .btn-klc { background:var(--klc-blue); color:#fff; }
    .btn-klc:hover { opacity:.9; color:#fff; }
    .hidden { display:none!important; }
    .required::after { content:" *"; color:#d00; }
    .small-scroll { max-height:420px; overflow:auto; }
    code, pre { user-select:text; }
  </style>
</head>
<body>
  <nav class="navbar klc-navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">KLC Nội bộ</a>
      <div class="ms-auto d-flex align-items-center gap-3">
        <span id="meBox" class="navbar-text small"></span>
      </div>
    </div>
  </nav>

  <div class="container py-4">

    <!-- Signed-out -->
    <div id="signedOut" class="text-center py-5">
      <h4 class="mb-3">Đăng nhập Google để tiếp tục</h4>
      <div id="gbtnWrap" class="d-inline-block"></div>
      <div id="debug" class="small text-danger mt-2"></div>
      <p class="text-muted mt-3">Chỉ tài khoản có trong sheet <code>users</code> (status=active) mới truy cập được.</p>
    </div>

    <!-- App -->
    <div id="app" class="hidden">
      <!-- Menu -->
      <ul class="nav nav-pills mb-3" id="menu">
        <li class="nav-item"><a class="nav-link active" data-section="dashboard" href="#">Trang chủ</a></li>
        <li class="nav-item"><a class="nav-link" data-section="customers" href="#">Khách hàng</a></li>
        <li class="nav-item"><a class="nav-link" data-section="cskh" href="#">CSKH</a></li>
        <li class="nav-item"><a class="nav-link" data-section="warranty" href="#">Bảo hành & BD</a></li>
        <li class="nav-item"><a class="nav-link" data-section="inventory" href="#">Tồn kho</a></li>
        <li class="nav-item"><a class="nav-link" data-section="finance" href="#">Thu & Chi</a></li>
        <li class="nav-item"><a class="nav-link d-none" id="adminTab" data-section="admin" href="#">Quản trị</a></li>
      </ul>

      <!-- DASHBOARD -->
      <section id="section-dashboard">
        <div class="d-flex gap-2 align-items-center mb-3">
          <label class="me-2">Tháng:</label>
          <input id="dashMonth" type="number" min="1" max="12" class="form-control" style="width:120px" />
          <button class="btn btn-klc" onclick="loadDashboard()">Tải</button>
        </div>
        <div id="dashCards" class="row g-3"></div>
        <pre class="mt-3 small text-muted" id="dashRaw"></pre>
      </section>

      <!-- CUSTOMERS -->
      <section id="section-customers" class="hidden">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-3">Thêm/Chỉnh khách</h5>
              <div class="mb-2"><label class="form-label required">Tên</label><input id="c_ten" class="form-control"></div>
              <div class="mb-2"><label class="form-label required">Số điện thoại</label><input id="c_phone" class="form-control" placeholder="Tự chuẩn hoá 0xxx…" onblur="autoSuggestByPhone()"></div>
              <div class="mb-2"><label class="form-label">Ngày</label><input id="c_ngay" class="form-control" placeholder="dd/MM/yyyy"></div>
              <div class="mb-2"><label class="form-label">Địa chỉ</label><input id="c_diachi" class="form-control"></div>
              <div class="mb-2">
                <label class="form-label">Nguồn khách</label>
                <select id="c_nguon" class="form-select">
                  <option>walk_in</option><option>facebook</option><option>zalo</option><option>tiktok</option><option>referral</option><option>ads</option><option>hotline</option><option>khac</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">Trạng thái mua</label>
                <select id="c_status" class="form-select"><option>Chưa mua</option><option>Đã mua</option></select>
              </div>
              <div class="mb-2"><label class="form-label">Mẫu ghế</label><input id="c_model" class="form-control" placeholder="VD: KY02"></div>
              <div class="mb-2"><label class="form-label">Giá bán</label><input id="c_gia" type="number" class="form-control"></div>
              <div class="mb-2"><label class="form-label">Số năm bảo hành</label><input id="c_bhn" type="number" class="form-control" placeholder="mặc định 3"></div>
              <div class="mb-2"><label class="form-label">Ghi chú</label><textarea id="c_note" class="form-control"></textarea></div>
              <div class="d-flex gap-2">
                <button class="btn btn-klc" onclick="saveCustomer()">Lưu</button>
                <button class="btn btn-outline-secondary" onclick="clearCustomerForm()">Xoá form</button>
                <button class="btn btn-outline-primary" onclick="exportCsv('customers')">Xuất CSV</button>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-3">Danh sách tháng</h5>
              <div class="d-flex gap-2 mb-2">
                <input id="cl_month" type="number" min="1" max="12" class="form-control" style="max-width:120px" placeholder="Tháng">
                <button class="btn btn-klc" onclick="loadCustomers()">Tải</button>
              </div>
              <input id="c_search" class="form-control mb-2" placeholder="Tìm theo tên/điện thoại" oninput="filterCustomerList()">
              <div id="c_list" class="small small-scroll"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- CSKH -->
      <section id="section-cskh" class="hidden">
        <div class="card p-3">
          <h5 class="mb-3">Tạo CSKH</h5>
          <div class="row g-2">
            <div class="col-md-3"><input id="care_ngay" class="form-control" placeholder="dd/MM/yyyy"></div>
            <div class="col-md-3"><input id="care_customer_id" class="form-control" placeholder="customer_id (chọn từ Khách hàng)"></div>
            <div class="col-md-3"><input id="care_nv" class="form-control" placeholder="nhân viên"></div>
            <div class="col-md-3"><select id="care_kenh" class="form-select"><option>Gọi điện</option><option>Nhắn tin</option><option>Zalo</option><option>Facebook</option><option>Trực tiếp</option></select></div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-md-6"><input id="care_noi_dung" class="form-control" placeholder="Nội dung CSKH"></div>
            <div class="col-md-6"><input id="care_phan_hoi" class="form-control" placeholder="Phản hồi khách"></div>
          </div>
          <div class="mt-2">
            <label class="me-2">Trạng thái tiềm năng (chọn 1):</label>
            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="care_flag" id="f1"><label class="form-check-label" for="f1">còn tiềm năng</label></div>
            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="care_flag" id="f2"><label class="form-check-label" for="f2">hết tiềm năng</label></div>
            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="care_flag" id="f3"><label class="form-check-label" for="f3">đang nuôi khách</label></div>
            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="care_flag" id="f4"><label class="form-check-label" for="f4">đang hẹn lên</label></div>
            <input id="care_next" class="form-control mt-2" placeholder="next_action_date dd/MM/yyyy">
          </div>
          <div class="mt-2"><button class="btn btn-klc" onclick="saveCSKH()">Lưu CSKH</button> <button class="btn btn-outline-primary" onclick="exportCsv('cskh')">Xuất CSV</button></div>
        </div>
      </section>

      <!-- WARRANTY -->
      <section id="section-warranty" class="hidden">
        <div class="card p-3">
          <div class="d-flex gap-2 align-items-center mb-2">
            <label>Tháng:</label>
            <input id="w_month" type="number" min="1" max="12" class="form-control" style="width:120px">
            <button class="btn btn-klc" onclick="loadWarranty()">Tải</button>
            <button class="btn btn-outline-primary ms-auto" onclick="exportCsv('warranty_service')">Xuất CSV</button>
          </div>
          <div id="w_list" class="small small-scroll"></div>
        </div>
      </section>

      <!-- INVENTORY -->
      <section id="section-inventory" class="hidden">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">Phiếu Nhập/Xuất</h5>
              <div class="row g-2">
                <div class="col-4"><input id="i_ngay" class="form-control" placeholder="dd/MM/yyyy"></div>
                <div class="col-4"><input id="i_model" class="form-control" placeholder="VD: KY02"></div>
                <div class="col-4"><select id="i_huong" class="form-select"><option>Nhập</option><option>Xuất</option></select></div>
              </div>
              <div class="row g-2 mt-2">
                <div class="col-4"><input id="i_qty" type="number" min="1" class="form-control" placeholder="Số lượng"></div>
                <div class="col-4"><input id="i_lydo" class="form-control" placeholder="Lý do"></div>
                <div class="col-4"><input id="i_nguon" class="form-control" placeholder="Nguồn nhập/xuất"></div>
              </div>
              <input id="i_ref" class="form-control mt-2" placeholder="Tham chiếu (mã đơn)">
              <textarea id="i_note" class="form-control mt-2" placeholder="Ghi chú"></textarea>
              <div class="mt-2 d-flex gap-2"><button class="btn btn-klc" onclick="saveInv()">Lưu</button><button class="btn btn-outline-primary" onclick="exportCsv('inventory_movements')">Xuất CSV</button></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">Tồn kho hiện tại</h5>
              <div id="stock" class="small small-scroll"></div>
              <div class="mt-2"><button class="btn btn-klc" onclick="loadStock()">Tải tồn kho</button></div>
            </div>
          </div>
        </div>
      </section>

      <!-- FINANCE -->
      <section id="section-finance" class="hidden">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">Ghi Thu/Chi</h5>
              <div class="row g-2">
                <div class="col-4"><input id="f_ngay" class="form-control" placeholder="dd/MM/yyyy"></div>
                <div class="col-3"><select id="f_loai" class="form-select"><option>Thu</option><option>Chi</option></select></div>
                <div class="col-5"><input id="f_nhom" class="form-control" placeholder="Nhóm (VD: Doanh thu bán ghế)"></div>
              </div>
              <div class="row g-2 mt-2">
                <div class="col-7"><input id="f_noi_dung" class="form-control" placeholder="Nội dung"></div>
                <div class="col-5"><input id="f_tien" type="number" class="form-control" placeholder="Số tiền (VND)"></div>
              </div>
              <div class="row g-2 mt-2">
                <div class="col-4"><input id="f_pt" class="form-control" placeholder="Phương thức (Tiền mặt/CK/...)"></div>
                <div class="col-8"><input id="f_ct" class="form-control" placeholder="Chứng từ (mã/link)"></div>
              </div>
              <textarea id="f_note" class="form-control mt-2" placeholder="Ghi chú"></textarea>
              <div class="mt-2 d-flex gap-2"><button class="btn btn-klc" onclick="saveFinance()">Lưu</button><button class="btn btn-outline-primary" onclick="exportCsv('finance')">Xuất CSV</button></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">Tổng hợp tháng</h5>
              <div class="d-flex gap-2 align-items-center mb-2">
                <input id="fin_month" type="number" min="1" max="12" class="form-control" style="max-width:120px" placeholder="Tháng">
                <button class="btn btn-klc" onclick="loadFinance()">Tải</button>
              </div>
              <div id="fin_summary" class="small"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ADMIN -->
      <section id="section-admin" class="hidden">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">Quản lý User</h5>
              <div class="row g-2">
                <div class="col-5"><input id="u_email" class="form-control" placeholder="email"></div>
                <div class="col-3"><input id="u_ten" class="form-control" placeholder="tên"></div>
                <div class="col-2"><select id="u_role" class="form-select"><option>staff</option><option>admin</option></select></div>
                <div class="col-2"><select id="u_status" class="form-select"><option>active</option><option>suspended</option></select></div>
              </div>
              <div class="mt-2"><button class="btn btn-klc" onclick="saveUser()">Lưu/Upsert</button></div>
              <div id="users_list" class="small mt-3 small-scroll"></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">Cấu hình & Danh mục</h5>
              <div class="row g-2">
                <div class="col-6"><input id="s_min_stock" class="form-control" placeholder="min_stock_threshold"></div>
                <div class="col-6"><input id="s_dash_month" class="form-control" placeholder="dashboard_month"></div>
              </div>
              <div class="mt-2 d-flex gap-2">
                <button class="btn btn-klc" onclick="saveSetting('min_stock_threshold', document.getElementById('s_min_stock').value)">Lưu ngưỡng tồn</button>
                <button class="btn btn-klc" onclick="saveSetting('dashboard_month', document.getElementById('s_dash_month').value)">Lưu tháng mặc định</button>
              </div>
              <hr/>
              <div class="row g-2">
                <div class="col-4"><input id="cat_code" class="form-control" placeholder="model_code"></div>
                <div class="col-5"><input id="cat_name" class="form-control" placeholder="model_name"></div>
                <div class="col-3"><input id="cat_bh" class="form-control" placeholder="BH mặc định (năm)"></div>
              </div>
              <div class="mt-2"><button class="btn btn-klc" onclick="saveCatalog()">Lưu mẫu ghế</button></div>
              <div id="catalog_list" class="small mt-3 small-scroll"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
/* ======= CONFIG (đã gắn sẵn của bạn) ======= */
const GOOGLE_CLIENT_ID = "229964671691-jvq8pstlajqa9v6g0rhfi0u8ei39453u.apps.googleusercontent.com";
const API_URL = "https://script.google.com/macros/s/AKfycbxscUm2o0q70dsQm3mERQyyZWejd2TmQREfqXZ6qkbQtQYx-OWuB5BDFmBpBJj6_ebw/exec";

let ID_TOKEN = "";
let ME = null;

function dlog(m){ const e=document.getElementById('debug'); if(e) e.textContent=m; console.error(m); }

/* ======= LOGIN (GIS) ======= */
window.onload = function(){
  try{
    if (!window.google || !google.accounts || !google.accounts.id){
      dlog('Không tải được Google Sign-In. Kiểm tra mạng/extension chặn script.');
      return;
    }
    google.accounts.id.initialize({
      client_id: GOOGLE_CLIENT_ID,
      callback: onCredentialResponse,
      auto_select: false,
      cancel_on_tap_outside: true,
      ux_mode: 'popup'
    });
    google.accounts.id.renderButton(
      document.getElementById("gbtnWrap"),
      { theme: "outline", size: "large", width: 250 }
    );
  }catch(e){ dlog('Lỗi init GIS: ' + e); }
};
function onCredentialResponse(resp){ ID_TOKEN = resp.credential || ""; postLogin(); }

/* ======= API WRAPPER (fetch -> Apps Script doPost) ======= */
async function callApi(action, payload){
  const body = { action, payload, id_token: ID_TOKEN };
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(body)
  });
  const json = await res.json();
  if (!json.ok){ throw new Error(json.error || "UNKNOWN"); }
  return json.data;
}

/* ======= POST LOGIN ======= */
function postLogin(){
  callApi("me", {}).then(me=>{
    ME = me;
    document.getElementById("signedOut").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("meBox").textContent = me.email + " (" + me.role + ")";
    if ((me.role||"staff")==="admin") document.getElementById("adminTab").classList.remove("d-none");
    document.getElementById("dashMonth").value = new Date().getMonth()+1;
    document.getElementById("cl_month").value  = new Date().getMonth()+1;
    document.getElementById("w_month").value   = new Date().getMonth()+1;
    document.getElementById("fin_month").value = new Date().getMonth()+1;
    loadDashboard(); bindMenu(); loadUsers(); loadCatalog();
  }).catch(err=>{
    alert("Không có quyền hoặc tài khoản chưa được cấp ('users'). Chi tiết: " + err);
  });
}

/* ======= MENU ======= */
function bindMenu(){
  document.querySelectorAll('#menu .nav-link').forEach(a=>{
    a.onclick = (e)=>{
      e.preventDefault();
      document.querySelectorAll('#menu .nav-link').forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
      const sec = a.getAttribute('data-section');
      document.querySelectorAll('section[id^="section-"]').forEach(s=>s.classList.add('hidden'));
      document.getElementById('section-'+sec).classList.remove('hidden');
    };
  });
}

/* ======= DASHBOARD ======= */
async function loadDashboard(){
  const m = Number(document.getElementById("dashMonth").value || 0);
  const d = await callApi("dashboard", {month:m});
  const cards = [];
  cards.push(cardKPI("Khách mới", d.khachHangMoi));
  cards.push(cardKPI("Đã mua", d.daMua) + cardKPI("Chưa mua", d.chuaMua));
  cards.push(cardKPI("CSKH (phiên)", d.soPhienCSKH) + cardKPI("Tỉ lệ có next", (d.tiLeNext*100).toFixed(0)+"%"));
  cards.push(cardKPI("Bảo dưỡng: Đến kỳ", d.baoDuong.denKy) + cardKPI("Đã xử lý", d.baoDuong.daXL) + cardKPI("Quá hạn", d.baoDuong.quaHan));
  const ton = (d.tonKho||[]).map(x=>`${x.model}: ${x.ton_cuoi}${x.thap?' 🔻':''}`).join("<br>");
  cards.push(`<div class="col-md-4"><div class="card p-3"><div class="fw-bold">Top tồn thấp</div><div class="small mt-2">${ton||'—'}</div></div></div>`);
  const sell = (d.topSell||[]).map(x=>`${x.model}: ${x.qty}`).join("<br>");
  cards.push(`<div class="col-md-4"><div class="card p-3"><div class="fw-bold">Mẫu bán chạy</div><div class="small mt-2">${sell||'—'}</div></div></div>`);
  document.getElementById("dashCards").innerHTML = cards.join("");
  document.getElementById("dashRaw").textContent = JSON.stringify(d, null, 2);
}
function cardKPI(label, value){
  return `<div class="col-md-4"><div class="card p-3"><div class="text-muted small">${label}</div><div class="fs-3 fw-bold">${value}</div></div></div>`;
}

/* ======= CUSTOMERS ======= */
function byId(id){ return (document.getElementById(id).value||"").trim(); }
function fmtDate(v){
  try{ if(!v) return ""; if (typeof v==="string" && v.includes("/")) return v;
       const d=new Date(v); const dd=("0"+d.getDate()).slice(-2), mm=("0"+(d.getMonth()+1)).slice(-2), yyyy=d.getFullYear();
       return `${dd}/${mm}/${yyyy}`; }catch(e){ return v; }
}
function clearCustomerForm(){ ["c_ten","c_phone","c_ngay","c_diachi","c_model","c_gia","c_bhn","c_note"].forEach(id=>document.getElementById(id).value=""); document.getElementById("c_nguon").value="khac"; document.getElementById("c_status").value="Chưa mua"; }
async function saveCustomer(){
  const p={ ten:byId("c_ten"), so_dien_thoai:byId("c_phone"), ngay:byId("c_ngay"), dia_chi:byId("c_diachi"),
            nguon_khach:byId("c_nguon"), trang_thai_mua:byId("c_status"), mau_ghe:byId("c_model"),
            gia_ban:Number(byId("c_gia")||0), so_nam_bao_hanh:Number(byId("c_bhn")||0), ghi_chu:byId("c_note") };
  try{ const r=await callApi("customer.create",p); alert("Đã lưu khách: " + r.id); clearCustomerForm(); loadCustomers(); }
  catch(e){ alert("Lỗi lưu khách: " + e); }
}
async function loadCustomers(){
  const month=Number(document.getElementById("cl_month").value||0);
  const list=await callApi("customer.list",{month}); window._CUSTOMERS=list; renderCustomerList(list);
}
function filterCustomerList(){
  const q=(document.getElementById("c_search").value||"").trim().toLowerCase();
  const list=(window._CUSTOMERS||[]).filter(x=> String(x.ten||"").toLowerCase().includes(q) || String(x.so_dien_thoai||"").includes(q) );
  renderCustomerList(list);
}
function renderCustomerList(list){
  const html = list.map(x=>{
    const btn = `<button class="btn btn-sm btn-outline-secondary" onclick="prefillCSKH('${x.customer_id}','${(x.ten||"").replace(/'/g,"\\'")}','${x.so_dien_thoai||""}')">Sang CSKH</button>`;
    return `<div class="border rounded p-2 mb-2">
      <div class="d-flex justify-content-between">
        <div><b>${x.ten||"-"}</b> • ${x.so_dien_thoai||"-"} • ${x.nguon_khach||"-"} • ${x.trang_thai_mua||"-"} • ${x.mau_ghe||""}</div>
        <div class="small text-muted">${fmtDate(x.ngay)}</div>
      </div>
      <div class="mt-1">${x.dia_chi||""}</div>
      <div class="mt-1">${btn}</div>
    </div>`;
  }).join("");
  document.getElementById("c_list").innerHTML = html || "<div class='text-muted'>Không có dữ liệu</div>";
}
function prefillCSKH(cid,name,phone){ document.querySelector('#menu [data-section="cskh"]').click(); document.getElementById("care_customer_id").value=cid; document.getElementById("care_noi_dung").value="CSKH khách "+name+" ("+phone+")"; }
function autoSuggestByPhone(){
  const phone=(document.getElementById("c_phone").value||"").replace(/\D+/g,"").replace(/^84/,"0");
  if(!phone) return;
  const f=(window._CUSTOMERS||[]).find(x=>String(x.so_dien_thoai||"")===phone);
  if(f){ if(confirm(`Số này đã có khách "${f.ten||""}". Sang CSKH?`)){ prefillCSKH(f.customer_id,f.ten||"",f.so_dien_thoai||""); } }
}

/* ======= CSKH ======= */
async function saveCSKH(){
  const flags={con_tiem_nang:false,het_tiem_nang:false,dang_nuoi_khach:false,dang_hen_len:false};
  const map={f1:"con_tiem_nang",f2:"het_tiem_nang",f3:"dang_nuoi_khach",f4:"dang_hen_len"}; let picked=0;
  Object.keys(map).forEach(id=>{ if(document.getElementById(id).checked){ flags[map[id]]=true; picked++; } });
  if(picked!==1){ alert("Chọn đúng 1 trạng thái tiềm năng."); return; }
  const p={ ngay:byId("care_ngay"), customer_id:byId("care_customer_id"), nhan_vien:byId("care_nv"),
            noi_dung_cskh:byId("care_noi_dung"), phan_hoi_khach:byId("care_phan_hoi"), kenh:byId("care_kenh"),
            next_action_date:byId("care_next"), ...flags };
  try{ const r=await callApi("cskh.create",p); alert("Đã lưu CSKH: " + r.id); document.getElementById("care_noi_dung").value=""; document.getElementById("care_phan_hoi").value=""; }
  catch(e){ alert("Lỗi CSKH: " + e); }
}

/* ======= WARRANTY ======= */
async function loadWarranty(){
  const m=Number(byId("w_month")||0);
  const list=await callApi("warranty.byMonth",{month:m});
  const html=list.map(w=>{
    const handledBtn=(String(w.trang_thai)==="Đến kỳ")? `<button class="btn btn-sm btn-outline-success" onclick="markWS('${w.ws_id}')">Đánh dấu đã xử lý</button>` : "";
    return `<div class="border rounded p-2 mb-2">
      <div><b>${w.customer_id}</b> • ${w.mau_ghe||""} • ${w.loai}</div>
      <div class="small text-muted">Trạng thái: ${w.trang_thai||""} • Kỳ: ${w.ky_bao_duong_thang||""} • Dự kiến: ${fmtDate(w.ngay_du_kien)}</div>
      <div class="mt-1">${handledBtn}</div>
    </div>`;
  }).join("");
  document.getElementById("w_list").innerHTML = html || "<div class='text-muted'>Không có lịch trong tháng</div>";
}
async function markWS(id){ try{ await callApi("warranty.markHandled",{ws_id:id}); loadWarranty(); } catch(e){ alert("Không cập nhật được: " + e); } }

/* ======= INVENTORY ======= */
async function saveInv(){
  const p={ ngay:byId("i_ngay"), mau_ghe:byId("i_model"), huong:byId("i_huong"),
            so_luong:Number(byId("i_qty")||0), ly_do:byId("i_lydo"), nguon_nhap_xuat:byId("i_nguon"),
            tham_chieu:byId("i_ref"), ghi_chu:byId("i_note") };
  try{ const r=await callApi("inv.create",p); alert("Đã ghi phiếu: " + r.id); loadStock(); }
  catch(e){ alert("Lỗi nhập/xuất: " + e); }
}
async function loadStock(){
  const rows=await callApi("inv.stockView",{});
  const html=rows.map(x=>`<div class="border rounded p-2 mb-2"><b>${x.mau_ghe}</b> — tồn: ${x.ton_cuoi} (đầu: ${x.ton_dau}, nhập: ${x.nhap}, xuất: ${x.xuat})</div>`).join("");
  document.getElementById("stock").innerHTML = html || "<div class='text-muted'>Chưa có</div>";
}

/* ======= FINANCE ======= */
async function saveFinance(){
  const p={ ngay:byId("f_ngay"), loai:byId("f_loai"), nhom:byId("f_nhom"), noi_dung:byId("f_noi_dung"),
            so_tien:Number(byId("f_tien")||0), phuong_thuc:byId("f_pt"), chung_tu:byId("f_ct"), ghi_chu:byId("f_note") };
  try{ await callApi("fin.create",p); alert("Đã ghi Thu/Chi"); loadFinance(); }
  catch(e){ alert("Lỗi Thu/Chi: " + e); }
}
async function loadFinance(){
  const m=Number(byId("fin_month")||0); const r=await callApi("fin.monthly",{month:m});
  const nf=(v)=>new Intl.NumberFormat("vi-VN").format(v);
  document.getElementById("fin_summary").innerHTML =
    `<div>Tổng Thu: <b>${nf(r.sumThu)}</b></div><div>Tổng Chi: <b>${nf(r.sumChi)}</b></div><div>Lợi nhuận gộp: <b>${nf(r.loiNhuan)}</b></div>`;
}

/* ======= ADMIN ======= */
async function saveUser(){ const p={email:byId("u_email"),ten:byId("u_ten"),role:byId("u_role"),status:byId("u_status")};
  try{ await callApi("admin.users.upsert",p); alert("Đã lưu user"); loadUsers(); } catch(e){ alert("Lỗi user: "+e); } }
async function loadUsers(){
  try{
    const r=await callApi("admin.users.get",{}); const iEmail=r.headers.indexOf("email");
    const list=r.rows.map(row=>`<div class="border rounded p-2 mb-2">${row[iEmail]} — ${row.join(" | ")}</div>`).join("");
    document.getElementById("users_list").innerHTML=list||"—";
  }catch(e){/* staff ko có quyền */}
}
async function saveSetting(k,v){ try{ await callApi("admin.settings.set",{key:k,value:v}); alert("Đã lưu setting: "+k); } catch(e){ alert("Lỗi setting: "+e);} }
async function saveCatalog(){
  try{ await callApi("admin.catalog.upsert",{ model_code:byId("cat_code"), model_name:byId("cat_name"), bao_hanh_mac_dinh_nam:Number(byId("cat_bh")||3)}); alert("Đã lưu mẫu ghế"); loadCatalog(); }
  catch(e){ alert("Lỗi catalog: "+e); }
}
async function loadCatalog(){
  try{
    const r=await callApi("admin.catalog.get",{}); const iCode=r.headers.indexOf("model_code"), iName=r.headers.indexOf("model_name"), iBH=r.headers.indexOf("bao_hanh_mac_dinh_nam");
    const list=r.rows.map(row=>`<div class="border rounded p-2 mb-2"><b>${row[iCode]}</b> — ${row[iName]} — BH ${row[iBH]} năm</div>`).join("");
    document.getElementById("catalog_list").innerHTML=list||"—";
  }catch(e){}
}

/* ======= CSV ======= */
async function exportCsv(sheet){
  try{
    const r=await callApi("export.csv",{sheet});
    const a=document.createElement("a"); a.href="data:text/csv;base64,"+r.base64; a.download=r.filename; document.body.appendChild(a); a.click(); a.remove();
  }catch(e){ alert("Không xuất được CSV: "+e); }
}

/* ======= Shortcuts ======= */
document.addEventListener("keydown", function(e){
  if (e.ctrlKey && e.key.toLowerCase()==="k"){
    e.preventDefault();
    const box = document.getElementById("c_search");
    if (!document.getElementById("section-customers").classList.contains("hidden")){ box.focus(); }
    else { document.querySelector('#menu [data-section="customers"]').click(); setTimeout(()=>box.focus(),150); }
  }
});
</script>
</body>
</html>
