# This script generates the requested KLC Bến Lức internal web (static) project,
# zips it, and provides a downloadable file.
import os, json, zipfile, textwrap, hashlib, io
from pathlib import Path
from PIL import Image, ImageDraw, ImageFont

base = Path("/mnt/data/klc-benluc")
assets = base / "assets"
cssdir = assets / "css"
imgdir = assets / "img"
iconsdir = assets / "icons"
jsdir = base / "js"
core = jsdir / "core"
modules = jsdir / "modules"
chartsdir = jsdir / "charts"

# Ensure directories
for p in [base, assets, cssdir, imgdir, iconsdir, jsdir, core, modules, chartsdir]:
    p.mkdir(parents=True, exist_ok=True)

# Precompute password hashes (SHA-256 hex)
def sha256_hex(s: str) -> str:
    return hashlib.sha256(s.encode("utf-8")).hexdigest()

ADMIN_USER = "admin"
ADMIN_PASS = "klcbenluc@2025"
STAFF_USER = "nhanvien"
STAFF_PASS = "123456"

ADMIN_HASH = sha256_hex(ADMIN_PASS)
STAFF_HASH = sha256_hex(STAFF_PASS)

# ---------- Write assets/css/brand.css ----------
brand_css = """
:root{
  --brand-gold: #F6C90E;
  --brand-blue: #0F52BA;
}
.bg-brand-blue{ background: var(--brand-blue); }
.text-brand-blue{ color: var(--brand-blue); }
.bg-brand-gold{ background: var(--brand-gold); }
.text-brand-gold{ color: var(--brand-gold); }

/* Global layout helpers */
.container-narrow{ max-width: 1100px; margin: 0 auto; }
.card{ @apply bg-white rounded-2xl shadow p-4 md:p-6; }
.card-header{ @apply font-semibold text-lg mb-3; }
.k-btn{ @apply rounded-xl px-4 py-2 font-medium transition; }
.k-btn-primary{ @apply text-black; background: var(--brand-gold); }
.k-btn-blue{ color: #fff; background: var(--brand-blue); }
.k-btn-outline{ @apply border; border-color: rgba(0,0,0,.12); }
.k-input{ @apply w-full rounded-xl border px-3 py-2 outline-none; border-color: rgba(0,0,0,.15); }
.k-select{ @apply w-full rounded-xl border px-3 py-2; border-color: rgba(0,0,0,.15); }
.k-label{ @apply text-sm font-medium text-gray-700 mb-1 block; }

/* Loading overlay */
#global-loading{
  position: fixed; inset: 0; background: rgba(0,0,0,.35);
  display: none; z-index: 9999; align-items: center; justify-content: center;
  backdrop-filter: blur(2px);
}
.loader-box{ background: rgba(255,255,255,.95); border-radius: 1rem; padding: 1.25rem 1.5rem; display:flex; gap:.75rem; align-items:center; box-shadow: 0 10px 25px rgba(0,0,0,.2); }
.spinner{
  width: 28px; height: 28px; border-radius: 9999px; border: 3px solid rgba(0,0,0,.1);
  border-top-color: var(--brand-blue); animation: spin .8s linear infinite;
}
@keyframes spin{ to{ transform: rotate(360deg);} }

/* Toasts */
#toast-area{ position: fixed; right: 16px; bottom: 16px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; }
.toast{
  padding: .65rem .9rem; border-radius: .9rem; box-shadow: 0 8px 20px rgba(0,0,0,.15);
  color: #111; background: #fff; border: 1px solid rgba(0,0,0,.08);
}
.toast.info{ border-left: 5px solid var(--brand-blue); }
.toast.success{ border-left: 5px solid #22c55e; }
.toast.warn{ border-left: 5px solid #f59e0b; }
.toast.error{ border-left: 5px solid #ef4444; }

/* Shell */
.app-header{
  @apply flex items-center justify-between px-4 py-3 md:px-6 sticky top-0 bg-white border-b;
  border-color: rgba(0,0,0,.06); z-index: 20;
}
.app-side{
  @apply hidden md:block w-64 shrink-0 border-r bg-white;
  border-color: rgba(0,0,0,.06);
}
.app-main{ @apply flex-1 p-4 md:p-6 bg-gray-50 min-h-screen; }
.nav-link{ @apply flex items-center gap-2 px-4 py-2 rounded-xl hover:bg-gray-100; }
.nav-link.active{ background: rgba(15,82,186,.08); color: var(--brand-blue); font-weight: 600; }

/* Bottom Nav for mobile */
.bottom-nav{ @apply md:hidden fixed bottom-0 left-0 right-0 bg-white border-t; border-color: rgba(0,0,0,.08); z-index: 30; }
.bottom-nav .bn-btn{ @apply flex-1 flex flex-col items-center justify-center py-2 text-xs; }
.bottom-nav .bn-btn.active{ color: var(--brand-blue); font-weight: 600; }
body{ @apply text-gray-800; }
"""
(cssdir / "brand.css").write_text(textwrap.dedent(brand_css), encoding="utf-8")

# ---------- Placeholder logo ----------
# Create a simple brand logo using PIL
logo = Image.new("RGBA", (420, 120), (255, 255, 255, 0))
d = ImageDraw.Draw(logo)
# Blue rounded rect background
d.rounded_rectangle([0,0,420,120], radius=24, fill=(15,82,186,255))
# Gold text "KLC"
try:
    # Not all fonts available; use default if not
    font = ImageFont.truetype("DejaVuSans-Bold.ttf", 72)
except:
    font = ImageFont.load_default()
text = "KLC"
tw, th = d.textbbox((0,0), text, font=font)[2:]
d.text(((420-tw)/2, (120-th)/2-6), text, font=font, fill=(246,201,14,255))
logo.save(imgdir / "logo.png", "PNG")

# ---------- Core JS ----------
utils_js = """
export const KEY = 'klc_app_v1';

export const dateISO = (d=new Date()) => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
export const now = () => new Date().toISOString();
export const makeId = (p='ID') => `${p}_${Math.random().toString(36).slice(2,8)}_${Date.now().toString(36)}`;

export const ddmmyyyy = (iso) => {
  if(!iso) return '';
  const [y,m,d] = iso.split('-');
  return `${d}/${m}/${y}`;
};

export const parseMoney = (v) => {
  if (typeof v === 'number') return v;
  return Number(String(v).replace(/[^0-9.-]/g,'')) || 0;
};
export const formatMoney = (n) =>
  (n||0).toLocaleString('vi-VN', { style:'currency', currency:'VND', maximumFractionDigits:0 });

export const phoneNorm = (s='') => s.replace(/\\D/g,'');

export const pick = (obj, keys=[]) => Object.fromEntries(keys.map(k=>[k,obj[k]]));

export const sleep = (ms=450) => new Promise(r=>setTimeout(r,ms));
"""
(core / "utils.js").write_text(textwrap.dedent(utils_js), encoding="utf-8")

storage_js = f"""
import {{ KEY, makeId, dateISO, now }} from './utils.js';

export function load(){{ 
  try{{ return JSON.parse(localStorage.getItem(KEY)) || {{}}; }}
  catch(e){{ return {{}}; }}
}}
export function save(data){{ localStorage.setItem(KEY, JSON.stringify(data)); }}

export function seedIfEmpty(){{ 
  const cur = load();
  if (cur && cur.users && cur.users.length) return;
  const seed = {{
    users: [
      {{ id: makeId('U'), username:'{ADMIN_USER}', passHash:'{ADMIN_HASH}', role:'admin', displayName:'Quản trị KLC', active:true }},
      {{ id: makeId('U'), username:'{STAFF_USER}', passHash:'{STAFF_HASH}', role:'staff', displayName:'Nhân viên KLC', active:true }}
    ],
    session: null,
    settings: {{
      employees: ['Đạt','Nguyên','Tâm','Vy','Kha'],
      brand: {{ gold:'#F6C90E', blue:'#0F52BA' }},
      models: ['KY01','KY02','KY05','KY12','KY15','KY20','RO66','RO68','K7979 LUXURY']
    }},
    customers: [
      {{ id: makeId('C'), date: dateISO(), name:'Anh Vũ', phone:'0909000001', address:'Bến Lức, Long An', source:{{type:'Khách ghé ngang'}}, status:{{ purchased:true, model:'KY02', price:15990000 }}, note:'Đã giao lễ Vu Lan' }},
      {{ id: makeId('C'), date: dateISO(), name:'Chị Vy', phone:'0909000002', address:'Tân An, Long An', source:{{type:'Khách online', detail:'Bài viết Vu Lan'}}, status:{{ purchased:false, consults:[{{model:'RO68', price:32990000, installment:true}}] }}, note:'Hẹn lên showroom CN' }}
    ],
    care: [
      {{ id: makeId('K'), date: dateISO(), name:'Chị Vy', phone:'0909000002', address:'Tân An', staff:'Vy', method:'call+sms', content:'Tư vấn RO68', feedback:'Quan tâm trả góp', note:'Chốt hẹn CN', rating:{{potential:true, nurturing:true, appointment:true}} }}
    ],
    warranty: [
      {{ id: makeId('W'), date: dateISO(), name:'Cô Dãnh', phone:'0909000003', address:'Bến Lức', model:'KY15', status:'Lỗi remote', extra:'Kiểm tra tại nhà', done:false }}
    ],
    maintenance: [
      {{ id: makeId('M'), date: dateISO(), name:'Anh Kha', phone:'0909000004', address:'Bến Lức', model:'RO66', extra:'Bảo dưỡng định kỳ 6 tháng', done:false }}
    ],
    tasks: [
      {{ id: makeId('T'), date: dateISO(), staff:'Nguyên', shift:'morning', slots:[
        {{ time:'08:30', label:'Dọn vệ sinh khu trải nghiệm', done:true }},
        {{ time:'10:00', label:'Gọi CSKH khách cũ', done:false, reason:'Bận khách', eta:'15:00' }}
      ], summary:'Buổi sáng ổn', }}
    ],
    inventory: [
      {{ id: makeId('I'), date: dateISO(), model:'KY02', color:'Đen', serial:'KY02-001', location:'Kho', inQty:5, outQty:1, balance:4 }},
      {{ id: makeId('I'), date: dateISO(), model:'RO68', color:'Nâu', serial:'RO68-010', location:'Showroom', inQty:2, outQty:0, balance:2 }}
    ],
    finance: [
      {{ id: makeId('F'), date: dateISO(), type:'income', category:'Bán hàng', title:'Bán KY02', amount:15990000, note:'COD' }},
      {{ id: makeId('F'), date: dateISO(), type:'expense', category:'Marketing', title:'Quảng cáo FB', amount:1500000, note:'Audience Network' }}
    ],
    notifications: [
      {{ id: makeId('N'), createdAt: now(), type:'system', level:'info', message:'Chào mừng đến KLC Bến Lức v1!', read:false }}
    ]
  }};
  save(seed);
}}

export const exportJSON = () => new Blob([JSON.stringify(load(), null, 2)], {{type:'application/json'}});
export function importJSONText(txt){{ try{{ save(JSON.parse(txt)); return true; }}catch(e){{ return false; }} }}
"""
(core / "storage.js").write_text(textwrap.dedent(storage_js), encoding="utf-8")

auth_js = """
import { load, save, seedIfEmpty } from './storage.js';
import { sleep } from './utils.js';
import { toast } from './ui.js';

// Simple SHA-256 via SubtleCrypto
export async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
}

export function currentSession(){
  const app = load();
  return app.session || null;
}
export function currentUser(){
  const app = load();
  if(!app.session) return null;
  return (app.users || []).find(u=>u.id===app.session.userId) || null;
}
export function isAdmin(){
  const s = currentSession();
  return s && s.role==='admin';
}

export async function login(username, password, remember=false, keep=false){
  seedIfEmpty();
  const app = load();
  const passHash = await sha256Hex(password);
  const user = (app.users||[]).find(u=>u.username===username && u.passHash===passHash && u.active!==false);
  await sleep(500);
  if(!user){
    toast('Sai tài khoản hoặc mật khẩu', 'error');
    return false;
  }
  const expiresAt = Date.now() + (keep ? 30*24*60*60*1000 : 6*60*60*1000); // 30 ngày vs 6 giờ
  app.session = { userId: user.id, role: user.role, remember: !!remember, deviceId: crypto.randomUUID(), expiresAt };
  save(app);
  toast('Đăng nhập thành công', 'success');
  setTimeout(()=>location.href='dashboard.html', 400);
  return true;
}

export function logout(){
  const app = load();
  app.session = null;
  save(app);
  location.href = 'index.html';
}

export function guard(requiredRole=null){
  seedIfEmpty();
  const app = load();
  const s = app.session;
  const path = location.pathname.split('/').pop();
  if(!s || !s.expiresAt || Date.now() > s.expiresAt){
    if(path!=='index.html' && path!==''){
      location.href='index.html';
    }
    return;
  }
  // Hide admin-only for staff
  if(requiredRole==='admin' || s.role!=='admin'){
    document.querySelectorAll('[data-role="adminOnly"]').forEach(el=>{
      el.classList.add('hidden');
      if(el.tagName==='BUTTON' || el.tagName==='INPUT' || el.tagName==='SELECT' || el.tagName==='TEXTAREA'){
        el.disabled = true;
      }
    });
    // Disable all form inputs for staff, but allow search/filter
    if(s.role!=='admin'){
      document.querySelectorAll('form .k-input, form .k-select, form input, form textarea, form select').forEach(el=>{
        if(!el.closest('[data-allow-staff]')) el.disabled = true;
      });
      document.querySelectorAll('button, .k-btn').forEach(btn=>{
        if(!btn.closest('[data-allow-staff]') && !btn.closest('.filter-bar')) btn.disabled = true;
      });
    }
  }
}
"""
(core / "auth.js").write_text(textwrap.dedent(auth_js), encoding="utf-8")

ui_js = """
// UI helpers: loading overlay, toast, header/nav injection
export function ensureLoading(){
  if(document.getElementById('global-loading')) return;
  const o = document.createElement('div');
  o.id = 'global-loading';
  o.innerHTML = `<div class="loader-box"><div class="spinner"></div><div id="loading-text" class="font-medium">Đang tải…</div></div>`;
  document.body.appendChild(o);
}
export function showLoading(msg='Đang tải…'){
  ensureLoading();
  const o = document.getElementById('global-loading');
  document.getElementById('loading-text').textContent = msg;
  o.style.display = 'flex';
}
export function hideLoading(){
  const o = document.getElementById('global-loading');
  if(o) o.style.display = 'none';
}

export function toast(msg, type='info', timeout=3000){
  let area = document.getElementById('toast-area');
  if(!area){
    area = document.createElement('div');
    area.id = 'toast-area';
    document.body.appendChild(area);
  }
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  area.appendChild(t);
  setTimeout(()=>{ t.remove(); }, timeout);
}

export function insertHeaderNav(active='dashboard'){
  const shell = document.getElementById('app-shell');
  if(!shell) return;
  shell.innerHTML = `
  <header class="app-header">
    <div class="flex items-center gap-3">
      <img src="assets/img/logo.png" class="w-10 h-10 rounded-xl shadow" alt="KLC">
      <div>
        <div class="font-semibold">KLC Bến Lức – Nội bộ</div>
        <div class="text-xs text-gray-500">Dẫn đầu công nghệ massage</div>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <button id="btnLogout" class="k-btn k-btn-outline">Đăng xuất</button>
    </div>
  </header>
  <div class="flex">
    <aside class="app-side">
      <nav class="p-4 flex flex-col gap-1">
        ${navLink('dashboard','Trang chủ', active==='dashboard')}
        ${navLink('customers','Khách hàng', active==='customers')}
        ${navLink('care','CSKH', active==='care')}
        ${navLink('service','Bảo hành & Bảo dưỡng', active==='service')}
        ${navLink('checklist','CheckList Công Việc', active==='checklist')}
        ${navLink('inventory','Tồn kho', active==='inventory')}
        ${navLink('finance','Thu & Chi', active==='finance')}
        ${navLink('system','Thông báo/Hệ thống', active==='system')}
      </nav>
    </aside>
    <main class="app-main w-full">
      <div id="page-content"></div>
    </main>
  </div>
  <nav class="bottom-nav flex">
    ${bnBtn('dashboard','Trang chủ', active==='dashboard')}
    ${bnBtn('customers','Khách hàng', active==='customers')}
    ${bnBtn('care','CSKH', active==='care')}
    ${bnBtn('more','Thêm', false)}
  </nav>
  `;
  function navLink(page, label, isActive){
    return `<a class="nav-link ${isActive?'active':''}" href="${page}.html">
      <span>${label}</span>
    </a>`;
  }
  function bnBtn(page,label,isActive){
    const href = page==='more' ? 'system.html' : `${page}.html`;
    return `<a class="bn-btn ${isActive?'active':''} flex-1" href="${href}"><span>${label}</span></a>`;
  }
  // Logout handler
  import('./auth.js').then(m=>{
    document.getElementById('btnLogout').addEventListener('click', m.logout);
  });
}
"""
(core / "ui.js").write_text(textwrap.dedent(ui_js), encoding="utf-8")

# ---------- charts.js ----------
charts_js = """
export function makeBar(ctx, labels, datasetLabel, data){
  return new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: datasetLabel, data, borderWidth: 1 }]},
    options: { responsive: true, plugins:{ legend:{display:true} } }
  });
}
export function makeLine(ctx, labels, datasetLabel, data){
  return new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: datasetLabel, data, borderWidth: 2, fill:false, tension:.25 }]},
    options: { responsive: true, plugins:{ legend:{display:true} } }
  });
}
export function makeDoughnut(ctx, labels, data){
  return new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data }]},
    options: { responsive: true, plugins:{ legend:{position:'bottom'} } }
  });
}
"""
(chartsdir / "charts.js").write_text(textwrap.dedent(charts_js), encoding="utf-8")

# ---------- Modules for each page ----------
dashboard_js = """
import { seedIfEmpty, load } from '../core/storage.js';
import { insertHeaderNav, showLoading, hideLoading } from '../core/ui.js';
import { guard } from '../core/auth.js';

seedIfEmpty();
insertHeaderNav('dashboard');
guard();

const content = document.getElementById('page-content');
content.innerHTML = `
  <div class="container-narrow mx-auto">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <div class="card"><div class="card-header">Hôm nay</div><div id="kpi-today" class="text-2xl font-bold">0</div></div>
      <div class="card"><div class="card-header">Tháng này</div><div id="kpi-month" class="text-2xl font-bold">0</div></div>
      <div class="card"><div class="card-header">Năm nay</div><div id="kpi-year" class="text-2xl font-bold">0</div></div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card">
        <div class="card-header">Khách theo ngày</div>
        <canvas id="chartCustomersDay"></canvas>
      </div>
      <div class="card">
        <div class="card-header">Nguồn khách</div>
        <canvas id="chartSources"></canvas>
      </div>
      <div class="card">
        <div class="card-header">Thu/Chi theo tháng</div>
        <canvas id="chartFinance"></canvas>
      </div>
      <div class="card">
        <div class="card-header">Bảo hành / Bảo dưỡng</div>
        <canvas id="chartService"></canvas>
      </div>
    </div>
  </div>
`;

(async function(){
  showLoading('Đang tổng hợp dữ liệu…');
  const app = load();
  const todayISO = new Date().toISOString().slice(0,10);
  const thisMonth = todayISO.slice(0,7);
  const thisYear = todayISO.slice(0,4);

  const kpiToday = (app.customers||[]).filter(c=>c.date===todayISO).length;
  const kpiMonth = (app.customers||[]).filter(c=>c.date?.startsWith(thisMonth)).length;
  const kpiYear = (app.customers||[]).filter(c=>c.date?.startsWith(thisYear)).length;
  document.getElementById('kpi-today').textContent = kpiToday;
  document.getElementById('kpi-month').textContent = kpiMonth;
  document.getElementById('kpi-year').textContent = kpiYear;

  // Charts
  const days = Array.from({length: 7}, (_,i)=>{
    const d = new Date(); d.setDate(d.getDate()-(6-i));
    return d.toISOString().slice(0,10);
  });
  const dayCounts = days.map(d => (app.customers||[]).filter(c=>c.date===d).length);

  const srcMap = {};
  (app.customers||[]).forEach(c=>{
    const t = c.source?.type || 'Khác';
    srcMap[t] = (srcMap[t]||0)+1;
  });
  const srcLabels = Object.keys(srcMap);
  const srcValues = Object.values(srcMap);

  const months = Array.from({length: 6}, (_,i)=>{
    const d = new Date(); d.setMonth(d.getMonth()-(5-i));
    return d.toISOString().slice(0,7);
  });
  const income = months.map(m => (app.finance||[]).filter(f=>f.type==='income' && f.date?.startsWith(m)).reduce((s,x)=>s+(x.amount||0),0));
  const expense = months.map(m => (app.finance||[]).filter(f=>f.type==='expense' && f.date?.startsWith(m)).reduce((s,x)=>s+(x.amount||0),0));

  const svcMonths = months;
  const warranty = svcMonths.map(m => (app.warranty||[]).filter(x=>x.date?.startsWith(m)).length);
  const maintenance = svcMonths.map(m => (app.maintenance||[]).filter(x=>x.date?.startsWith(m)).length);

  // Draw
  const { makeBar, makeDoughnut, makeLine } = await import('../charts/charts.js');
  makeBar(document.getElementById('chartCustomersDay'), days, 'Khách/ngày', dayCounts);
  makeDoughnut(document.getElementById('chartSources'), srcLabels, srcValues);
  const ctx = document.getElementById('chartFinance').getContext('2d');
  new Chart(ctx, {
    type:'line',
    data:{ labels: months, datasets:[
      {label:'Thu', data: income, tension:.25, borderWidth:2},
      {label:'Chi', data: expense, tension:.25, borderWidth:2}
    ]},
    options:{ responsive:true }
  });
  const ctx2 = document.getElementById('chartService').getContext('2d');
  new Chart(ctx2, {
    type:'bar',
    data:{ labels: svcMonths, datasets:[
      {label:'Bảo hành', data:warranty},
      {label:'Bảo dưỡng', data:maintenance}
    ]},
    options:{ responsive:true }
  });
  hideLoading();
})();
"""
(modules / "dashboard.js").write_text(textwrap.dedent(dashboard_js), encoding="utf-8")

customers_js = """
import { seedIfEmpty, load, save } from '../core/storage.js';
import { insertHeaderNav, showLoading, hideLoading, toast } from '../core/ui.js';
import { guard } from '../core/auth.js';
import { makeId } from '../core/utils.js';

seedIfEmpty();
insertHeaderNav('customers');
guard();

const content = document.getElementById('page-content');
content.innerHTML = `
  <div class="container-narrow mx-auto">
    <div class="card mb-4">
      <div class="card-header">Thêm khách hàng</div>
      <form id="customerForm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="k-label">Ngày</label><input type="date" class="k-input" name="date" required></div>
          <div><label class="k-label">Tên</label><input class="k-input" name="name" placeholder="Tên khách" required></div>
          <div><label class="k-label">Số điện thoại</label><input class="k-input" name="phone" placeholder="0xxxxxxxxx" required></div>
          <div><label class="k-label">Địa chỉ</label><input class="k-input" name="address" placeholder="Địa chỉ"></div>
          <div>
            <label class="k-label">Nguồn khách</label>
            <select class="k-select" name="sourceType" required>
              <option>Khách ghé ngang</option>
              <option>Khách online</option>
              <option>Khách cũ giới thiệu</option>
              <option>Khách cũ mua lại</option>
              <option>Người quen nhân viên</option>
              <option>Khác</option>
            </select>
          </div>
          <div><label class="k-label">Chi tiết nguồn</label><input class="k-input" name="sourceDetail" placeholder="VD: Bài Vu Lan"></div>
          <div class="md:col-span-2">
            <label class="k-label">Tình trạng mua hàng</label>
            <div class="flex items-center gap-4">
              <label class="flex items-center gap-2"><input type="radio" name="purchased" value="yes"> Đã mua</label>
              <label class="flex items-center gap-2"><input type="radio" name="purchased" value="no" checked> Chưa mua</label>
            </div>
          </div>
          <div id="purchasedFields" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
            <div><label class="k-label">Mẫu ghế</label><input class="k-input" name="model"></div>
            <div><label class="k-label">Giá bán</label><input class="k-input" name="price" placeholder="VND"></div>
          </div>
          <div id="consultArea" class="md:col-span-2">
            <label class="k-label">Đã tư vấn</label>
            <div id="consultList" class="space-y-2"></div>
            <button type="button" class="k-btn k-btn-outline mt-2" id="btnAddConsult">+ Thêm mẫu đã tư vấn</button>
          </div>
          <div class="md:col-span-2">
            <label class="k-label">Ghi chú</label>
            <textarea class="k-input" name="note"></textarea>
          </div>
        </div>
        <div class="mt-4 flex gap-2">
          <button class="k-btn k-btn-primary" type="submit">Lưu</button>
          <button class="k-btn k-btn-outline" type="reset">Xoá form</button>
        </div>
      </form>
    </div>

    <hr class="my-6 border-dashed">

    <div class="card">
      <div class="card-header">Danh sách khách hàng</div>
      <div class="filter-bar flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
        <input id="search" class="k-input md:w-1/2" placeholder="Tìm theo tên/SĐT/mẫu">
        <select id="filterStatus" class="k-select w-full md:w-48">
          <option value="">Tất cả</option>
          <option value="yes">Đã mua</option>
          <option value="no">Chưa mua</option>
        </select>
      </div>
      <div class="overflow-auto">
        <table class="w-full text-sm">
          <thead><tr class="text-left border-b"><th class="p-2">Ngày</th><th class="p-2">Tên</th><th class="p-2">SĐT</th><th class="p-2">Nguồn</th><th class="p-2">Trạng thái</th><th class="p-2">Hành động</th></tr></thead>
          <tbody id="tblCustomers"></tbody>
        </table>
      </div>
    </div>
  </div>
`;

const form = document.getElementById('customerForm');
const tbl = document.getElementById('tblCustomers');
const search = document.getElementById('search');
const filterStatus = document.getElementById('filterStatus');
const purchasedFields = document.getElementById('purchasedFields');
const consultArea = document.getElementById('consultArea');
const consultList = document.getElementById('consultList');
document.getElementsByName('purchased').forEach(r => r.addEventListener('change', e=>{
  purchasedFields.classList.toggle('hidden', e.target.value!=='yes');
  consultArea.classList.toggle('hidden', e.target.value==='yes');
}));
document.getElementById('btnAddConsult').addEventListener('click', addConsultRow);
addConsultRow();

function addConsultRow(){
  const row = document.createElement('div');
  row.className = 'grid grid-cols-1 md:grid-cols-3 gap-2';
  row.innerHTML = `
    <input class="k-input" placeholder="Mẫu ghế">
    <input class="k-input" placeholder="Giá">
    <label class="flex items-center gap-2"><input type="checkbox"> Trả góp</label>
  `;
  consultList.appendChild(row);
}

form.date.value = new Date().toISOString().slice(0,10);

form.addEventListener('submit', (e)=>{
  e.preventDefault();
  showLoading('Đang lưu khách hàng…');
  const app = load();
  const purchased = form.purchased.value==='yes';
  const item = {
    id: makeId('C'),
    date: form.date.value,
    name: form.name.value.trim(),
    phone: form.phone.value.trim(),
    address: form.address.value.trim(),
    source: { type: form.sourceType.value, detail: form.sourceDetail.value.trim() },
    status: purchased ? { purchased:true, model: form.model.value.trim(), price: Number(form.price.value||0) } : {
      purchased:false,
      consults: Array.from(consultList.children).map(r=>({ model:r.children[0].value, price:Number(r.children[1].value||0), installment:r.children[2].querySelector('input').checked }))
    },
    note: form.note.value.trim()
  };
  app.customers = app.customers || [];
  app.customers.unshift(item);
  save(app);
  setTimeout(()=>{
    hideLoading();
    toast('Đã lưu', 'success');
    form.reset();
    render();
  }, 400);
});

search.addEventListener('input', render);
filterStatus.addEventListener('change', render);

function render(){
  const app = load();
  let list = (app.customers||[]);
  const q = search.value.trim().toLowerCase();
  if(q){
    list = list.filter(c => [c.name, c.phone, c.status?.model, c.source?.type, c.source?.detail].filter(Boolean).join(' ').toLowerCase().includes(q));
  }
  const st = filterStatus.value;
  if(st){
    list = list.filter(c => String(!!c.status?.purchased) === String(st==='yes'));
  }
  tbl.innerHTML = list.slice(0,200).map(c=>`
    <tr class="border-b hover:bg-gray-50">
      <td class="p-2">${c.date||''}</td>
      <td class="p-2">${c.name||''}</td>
      <td class="p-2">${c.phone||''}</td>
      <td class="p-2">${c.source?.type||''}</td>
      <td class="p-2">${c.status?.purchased?'Đã mua':'Chưa mua'}</td>
      <td class="p-2"><a href="care.html" class="text-brand-blue underline">CSKH</a></td>
    </tr>
  `).join('');
}
render();
"""
(modules / "customers.js").write_text(textwrap.dedent(customers_js), encoding="utf-8")

care_js = """
import { seedIfEmpty, load, save } from '../core/storage.js';
import { insertHeaderNav, showLoading, hideLoading, toast } from '../core/ui.js';
import { guard } from '../core/auth.js';
import { makeId } from '../core/utils.js';

seedIfEmpty();
insertHeaderNav('care');
guard();

const content = document.getElementById('page-content');
content.innerHTML = `
  <div class="container-narrow mx-auto">
    <div class="card mb-4">
      <div class="card-header">Ghi nhận CSKH</div>
      <form id="careForm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="k-label">Ngày</label><input type="date" class="k-input" name="date" required></div>
          <div><label class="k-label">Nhân viên CSKH</label><input class="k-input" name="staff" placeholder="Tên NV"></div>
          <div><label class="k-label">Tên khách</label><input class="k-input" name="name" placeholder="Từ danh sách khách"></div>
          <div><label class="k-label">SĐT</label><input class="k-input" name="phone" placeholder="0xxxxxxxxx"></div>
          <div><label class="k-label">Địa chỉ</label><input class="k-input" name="address"></div>
          <div>
            <label class="k-label">Hình thức</label>
            <select class="k-select" name="method">
              <option>call</option><option>sms</option><option>broadcast</option><option>call+sms</option>
            </select>
          </div>
          <div class="md:col-span-2"><label class="k-label">Nội dung CSKH</label><textarea class="k-input" name="content"></textarea></div>
          <div class="md:col-span-2"><label class="k-label">Phản hồi khách</label><textarea class="k-input" name="feedback"></textarea></div>
          <div class="md:col-span-2"><label class="k-label">Ghi chú</label><textarea class="k-input" name="note"></textarea></div>
          <div class="md:col-span-2 grid grid-cols-2 md:grid-cols-4 gap-3">
            <label class="flex items-center gap-2"><input type="checkbox" name="potential"> Còn tiềm năng</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="nurturing"> Đang nuôi khách</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="appointment"> Đang hẹn lên</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="lost"> Hết tiềm năng</label>
          </div>
          <div id="lostReasonWrap" class="hidden md:col-span-2"><label class="k-label">Lý do hết tiềm năng</label><input class="k-input" name="lostReason"></div>
        </div>
        <div class="mt-4 flex gap-2">
          <button class="k-btn k-btn-primary" type="submit">Lưu</button>
          <button class="k-btn k-btn-outline" type="reset">Xoá form</button>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="card-header">Danh sách CSKH</div>
      <div class="filter-bar mb-3">
        <input id="search" class="k-input" placeholder="Tìm theo tên/SĐT/nội dung">
      </div>
      <div class="overflow-auto">
        <table class="w-full text-sm"><thead><tr class="text-left border-b"><th class="p-2">Ngày</th><th class="p-2">Tên</th><th class="p-2">SĐT</th><th class="p-2">Hình thức</th><th class="p-2">Trạng thái</th></tr></thead><tbody id="tblCare"></tbody></table>
      </div>
    </div>
  </div>
`;

const form = document.getElementById('careForm');
const tbl = document.getElementById('tblCare');
const search = document.getElementById('search');
const lost = form.lost;
const lostWrap = document.getElementById('lostReasonWrap');
lost.addEventListener('change', ()=> lostWrap.classList.toggle('hidden', !lost.checked));
form.date.value = new Date().toISOString().slice(0,10);

form.addEventListener('submit', (e)=>{
  e.preventDefault();
  showLoading('Đang lưu CSKH…');
  const app = load();
  const item = {
    id: makeId('K'),
    date: form.date.value,
    name: form.name.value.trim(),
    phone: form.phone.value.trim(),
    address: form.address.value.trim(),
    staff: form.staff.value.trim(),
    method: form.method.value,
    content: form.content.value.trim(),
    feedback: form.feedback.value.trim(),
    note: form.note.value.trim(),
    rating: {
      potential: form.potential.checked,
      nurturing: form.nurturing.checked,
      appointment: form.appointment.checked,
      lost: form.lost.checked ? { reason: form.lostReason.value.trim() } : null
    }
  };
  app.care = app.care || [];
  app.care.unshift(item);
  save(app);
  setTimeout(()=>{ hideLoading(); toast('Đã lưu', 'success'); form.reset(); render(); }, 400);
});

search.addEventListener('input', render);

function render(){
  const app = load();
  let list = app.care||[];
  const q = search.value.trim().toLowerCase();
  if(q) list = list.filter(k => [k.name,k.phone,k.content,k.feedback].filter(Boolean).join(' ').toLowerCase().includes(q));
  tbl.innerHTML = list.slice(0,200).map(k=>`
    <tr class="border-b hover:bg-gray-50">
      <td class="p-2">${k.date||''}</td>
      <td class="p-2">${k.name||''}</td>
      <td class="p-2">${k.phone||''}</td>
      <td class="p-2">${k.method||''}</td>
      <td class="p-2">${k.rating?.lost?'Hết tiềm năng': (k.rating?.appointment?'Hẹn lên': (k.rating?.nurturing?'Nuôi khách': (k.rating?.potential?'Tiềm năng':'')))}</td>
    </tr>
  `).join('');
}
render();
"""
(modules / "care.js").write_text(textwrap.dedent(care_js), encoding="utf-8")

service_js = """
import { seedIfEmpty, load, save } from '../core/storage.js';
import { insertHeaderNav, showLoading, hideLoading, toast } from '../core/ui.js';
import { guard } from '../core/auth.js';
import { makeId } from '../core/utils.js';

seedIfEmpty();
insertHeaderNav('service');
guard();

const content = document.getElementById('page-content');
content.innerHTML = `
  <div class="container-narrow mx-auto">
    <div class="card mb-4">
      <div class="card-header">Bảo hành & Bảo dưỡng</div>
      <div class="flex gap-3 mb-3">
        <button id="tabWarranty" class="k-btn k-btn-outline">Bảo hành</button>
        <button id="tabMaintenance" class="k-btn k-btn-outline">Bảo dưỡng</button>
      </div>
      <form id="serviceForm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="k-label">Ngày</label><input type="date" class="k-input" name="date" required></div>
          <div><label class="k-label">Tên</label><input class="k-input" name="name" required></div>
          <div><label class="k-label">SĐT</label><input class="k-input" name="phone"></div>
          <div><label class="k-label">Địa chỉ</label><input class="k-input" name="address"></div>
          <div><label class="k-label">Mẫu ghế</label><input class="k-input" name="model"></div>
          <div id="wStatusWrap"><label class="k-label">Tình trạng (BH)</label><input class="k-input" name="status"></div>
          <div class="md:col-span-2"><label class="k-label">Yêu cầu thêm</label><input class="k-input" name="extra"></div>
        </div>
        <div class="mt-4 flex gap-2">
          <button class="k-btn k-btn-primary" type="submit">Lưu</button>
          <button class="k-btn k-btn-outline" type="reset">Xoá form</button>
        </div>
      </form>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card">
        <div class="card-header">Danh sách Bảo hành</div>
        <div class="overflow-auto"><table class="w-full text-sm"><thead><tr class="text-left border-b"><th class="p-2">Ngày</th><th class="p-2">Tên</th><th class="p-2">Mẫu</th><th class="p-2">Tình trạng</th><th class="p-2">Hỗ trợ</th><th class="p-2">Linh kiện</th></tr></thead><tbody id="tblWarranty"></tbody></table></div>
      </div>
      <div class="card">
        <div class="card-header">Danh sách Bảo dưỡng</div>
        <div class="overflow-auto"><table class="w-full text-sm"><thead><tr class="text-left border-b"><th class="p-2">Ngày</th><th class="p-2">Tên</th><th class="p-2">Mẫu</th><th class="p-2">Trạng thái</th><th class="p-2">Linh kiện</th></tr></thead><tbody id="tblMaintenance"></tbody></table></div>
      </div>
    </div>
  </div>
`;

let curTab = 'warranty';
const form = document.getElementById('serviceForm');
const tblW = document.getElementById('tblWarranty');
const tblM = document.getElementById('tblMaintenance');
const tabW = document.getElementById('tabWarranty');
const tabM = document.getElementById('tabMaintenance');
const wStatusWrap = document.getElementById('wStatusWrap');

tabW.addEventListener('click', ()=>{ curTab='warranty'; wStatusWrap.classList.remove('hidden'); tabW.classList.add('k-btn-blue'); tabM.classList.remove('k-btn-blue'); });
tabM.addEventListener('click', ()=>{ curTab='maintenance'; wStatusWrap.classList.add('hidden'); tabM.classList.add('k-btn-blue'); tabW.classList.remove('k-btn-blue'); });

form.date.value = new Date().toISOString().slice(0,10);

form.addEventListener('submit', (e)=>{
  e.preventDefault(); showLoading('Đang lưu…');
  const app = load();
  if(curTab==='warranty'){
    const it = { id: makeId('W'), date: form.date.value, name: form.name.value, phone: form.phone.value, address: form.address.value, model: form.model.value, status: form.status.value, extra: form.extra.value, done:false };
    app.warranty = app.warranty || [];
    app.warranty.unshift(it);
  }else{
    const it = { id: makeId('M'), date: form.date.value, name: form.name.value, phone: form.phone.value, address: form.address.value, model: form.model.value, extra: form.extra.value, done:false };
    app.maintenance = app.maintenance || [];
    app.maintenance.unshift(it);
  }
  save(app);
  setTimeout(()=>{ hideLoading(); toast('Đã lưu', 'success'); form.reset(); render(); }, 400);
});

function render(){
  const app = load();
  tblW.innerHTML = (app.warranty||[]).map(w=>`
    <tr class="border-b">
      <td class="p-2">${w.date}</td>
      <td class="p-2">${w.name}</td>
      <td class="p-2">${w.model||''}</td>
      <td class="p-2">${w.status||''}</td>
      <td class="p-2">
        <label class="flex items-center gap-2"><input type="checkbox" ${w.done?'checked':''} data-w="${w.id}" class="toggleSupport"> Đã hỗ trợ</label>
      </td>
      <td class="p-2">
        <button class="k-btn k-btn-outline btnParts" data-w="${w.id}">+ Linh kiện</button>
      </td>
    </tr>
  `).join('');
  tblM.innerHTML = (app.maintenance||[]).map(m=>`
    <tr class="border-b">
      <td class="p-2">${m.date}</td>
      <td class="p-2">${m.name}</td>
      <td class="p-2">${m.model||''}</td>
      <td class="p-2">${m.done?'Đã hỗ trợ':'Chưa hỗ trợ'}</td>
      <td class="p-2"><button class="k-btn k-btn-outline btnPartsM" data-m="${m.id}">+ Linh kiện</button></td>
    </tr>
  `).join('');

  // handlers
  document.querySelectorAll('.toggleSupport').forEach(ch => ch.addEventListener('change', (e)=>{
    const id = e.target.dataset.w;
    const app = load();
    const it = (app.warranty||[]).find(x=>x.id===id);
    if(it){ it.done = e.target.checked; save(app); toast('Cập nhật xong', 'success'); }
  }));
  document.querySelectorAll('.btnParts').forEach(btn => btn.addEventListener('click', ()=>{
    const id = btn.dataset.w;
    const items = prompt('Nhập linh kiện đã gửi:');
    if(items!==null){
      const app = load();
      const it = (app.warranty||[]).find(x=>x.id===id);
      if(it){ it.parts = { sentAt: new Date().toISOString().slice(0,10), items }; save(app); toast('Đã lưu linh kiện', 'success'); render(); }
    }
  }));
  document.querySelectorAll('.btnPartsM').forEach(btn => btn.addEventListener('click', ()=>{
    const id = btn.dataset.m;
    const items = prompt('Nhập linh kiện đã gửi:');
    if(items!==null){
      const app = load();
      const it = (app.maintenance||[]).find(x=>x.id===id);
      if(it){ it.parts = { sentAt: new Date().toISOString().slice(0,10), items }; save(app); toast('Đã lưu linh kiện', 'success'); render(); }
    }
  }));
}
render();
"""
(modules / "service.js").write_text(textwrap.dedent(service_js), encoding="utf-8")

checklist_js = """
import { seedIfEmpty, load, save } from '../core/storage.js';
import { insertHeaderNav, showLoading, hideLoading, toast } from '../core/ui.js';
import { guard } from '../core/auth.js';
import { makeId } from '../core/utils.js';

seedIfEmpty();
insertHeaderNav('checklist');
guard();

const content = document.getElementById('page-content');
content.innerHTML = `
  <div class="container-narrow mx-auto">
    <div class="card mb-4">
      <div class="card-header">CheckList Công Việc</div>
      <form id="taskForm">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div><label class="k-label">Ngày</label><input class="k-input" type="date" name="date" required></div>
          <div><label class="k-label">Nhân viên</label><input class="k-input" name="staff" required></div>
          <div>
            <label class="k-label">Ca</label>
            <select class="k-select" name="shift">
              <option value="morning">Sáng (08:00–16:00)</option>
              <option value="afternoon">Chiều (13:00–21:00)</option>
              <option value="full">Full (08:00–21:00)</option>
            </select>
          </div>
        </div>
        <div class="mt-4">
          <div class="k-label">Khung giờ & công việc</div>
          <div id="slots" class="space-y-2"></div>
        </div>
        <div class="grid grid-cols-1 gap-3 mt-4">
          <div><label class="k-label">Tổng kết / Báo cáo</label><textarea class="k-input" name="summary"></textarea></div>
        </div>
        <div class="mt-4 flex gap-2">
          <button class="k-btn k-btn-primary" type="submit">Lưu</button>
          <button class="k-btn k-btn-outline" type="reset">Xoá form</button>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="card-header">Danh sách CheckList</div>
      <div class="filter-bar mb-3">
        <input id="search" class="k-input" placeholder="Tìm theo tên/ca/ngày">
      </div>
      <div class="overflow-auto">
        <table class="w-full text-sm"><thead><tr class="text-left border-b"><th class="p-2">Ngày</th><th class="p-2">Nhân viên</th><th class="p-2">Ca</th><th class="p-2">Tóm tắt</th></tr></thead><tbody id="tblTasks"></tbody></table>
      </div>
    </div>
  </div>
`;

const form = document.getElementById('taskForm');
const slotsWrap = document.getElementById('slots');
const tbl = document.getElementById('tblTasks');
const search = document.getElementById('search');
form.date.value = new Date().toISOString().slice(0,10);
renderSlots();

form.shift.addEventListener('change', renderSlots);
function renderSlots(){
  const shift = form.shift.value;
  let times = [];
  if(shift==='morning') times = ['08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00'];
  else if(shift==='afternoon') times = ['13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00'];
  else times = ['08:00','10:00','12:00','14:00','16:00','18:00','20:00'];
  slotsWrap.innerHTML = times.map(t=>`
    <div class="grid grid-cols-1 md:grid-cols-6 gap-2 items-center">
      <div class="text-sm text-gray-500">${t}</div>
      <input class="k-input md:col-span-3" placeholder="Công việc tại ${t}">
      <label class="flex items-center gap-2"><input type="checkbox"> Hoàn thành</label>
      <input class="k-input" placeholder="ETA (nếu chưa)">
    </div>
  `).join('');
}

form.addEventListener('submit', (e)=>{
  e.preventDefault(); showLoading('Đang lưu checklist…');
  const slots = Array.from(slotsWrap.children).map(r=>({ time:r.children[0].textContent, label:r.children[1].value, done:r.children[2].querySelector('input').checked, eta:r.children[3].value }));
  const app = load();
  const it = { id: makeId('T'), date: form.date.value, staff: form.staff.value, shift: form.shift.value, slots, summary: form.summary.value };
  app.tasks = app.tasks || []; app.tasks.unshift(it); save(app);
  setTimeout(()=>{ hideLoading(); toast('Đã lưu', 'success'); form.reset(); render(); }, 400);
});

search.addEventListener('input', render);

function render(){
  const app = load();
  let list = app.tasks||[];
  const q = search.value.trim().toLowerCase();
  if(q) list = list.filter(t => [t.date,t.staff,t.shift,t.summary].filter(Boolean).join(' ').toLowerCase().includes(q));
  tbl.innerHTML = list.slice(0,200).map(t=>`
    <tr class="border-b">
      <td class="p-2">${t.date}</td>
      <td class="p-2">${t.staff}</td>
      <td class="p-2">${t.shift}</td>
      <td class="p-2">${t.summary||''}</td>
    </tr>
  `).join('');
}
render();
"""
(modules / "checklist.js").write_text(textwrap.dedent(checklist_js), encoding="utf-8")

inventory_js = """
import { seedIfEmpty, load, save } from '../core/storage.js';
import { insertHeaderNav, showLoading, hideLoading, toast } from '../core/ui.js';
import { guard } from '../core/auth.js';
import { makeId } from '../core/utils.js';

seedIfEmpty();
insertHeaderNav('inventory');
guard();

const content = document.getElementById('page-content');
content.innerHTML = `
  <div class="container-narrow mx-auto">
    <div class="card mb-4">
      <div class="card-header">Nhập/Xuất/Điều chỉnh</div>
      <form id="invForm">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div><label class="k-label">Ngày</label><input class="k-input" type="date" name="date" required></div>
          <div><label class="k-label">Model</label><input class="k-input" name="model" required></div>
          <div><label class="k-label">Serial</label><input class="k-input" name="serial"></div>
          <div><label class="k-label">Màu</label><input class="k-input" name="color"></div>
          <div><label class="k-label">Vị trí</label><input class="k-input" name="location"></div>
          <div>
            <label class="k-label">Loại</label>
            <select class="k-select" name="type">
              <option value="in">Nhập</option>
              <option value="out">Xuất</option>
              <option value="adjust">Điều chỉnh</option>
            </select>
          </div>
          <div><label class="k-label">Số lượng</label><input class="k-input" name="qty" type="number" value="1"></div>
        </div>
        <div class="mt-4 flex gap-2">
          <button class="k-btn k-btn-primary" type="submit">Lưu</button>
          <button class="k-btn k-btn-outline" type="reset">Xoá form</button>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="card-header">Danh sách tồn kho</div>
      <div class="filter-bar mb-3 flex gap-2">
        <input id="search" class="k-input" placeholder="Tìm theo model/serial/vị trí">
      </div>
      <div class="overflow-auto"><table class="w-full text-sm"><thead><tr class="text-left border-b"><th class="p-2">Ngày</th><th class="p-2">Model</th><th class="p-2">Serial</th><th class="p-2">Loại</th><th class="p-2">SL</th><th class="p-2">Tồn cuối</th></tr></thead><tbody id="tblInv"></tbody></table></div>
    </div>
  </div>
`;

const form = document.getElementById('invForm');
const tbl = document.getElementById('tblInv');
const search = document.getElementById('search');
form.date.value = new Date().toISOString().slice(0,10);

form.addEventListener('submit', (e)=>{
  e.preventDefault(); showLoading('Đang lưu tồn kho…');
  const app = load();
  const type = form.type.value;
  const qty = Number(form.qty.value||0);
  const delta = type==='in' ? qty : type==='out' ? -qty : qty; // adjust uses qty directly (+/-)
  const prev = (app.inventory||[]).reduce((bal,x)=> bal + (x.inQty||0) - (x.outQty||0) + (x.type==='adjust'?(x.adjQty||0):0), 0);
  const balance = prev + (type==='in'?qty: type==='out'?-qty: (qty));
  const it = { id: makeId('I'), date: form.date.value, model: form.model.value, color: form.color.value, serial: form.serial.value, location: form.location.value,
               inQty: type==='in'?qty:0, outQty: type==='out'?qty:0, type, adjQty: type==='adjust'?qty:0, balance };
  app.inventory = app.inventory || []; app.inventory.unshift(it); save(app);
  setTimeout(()=>{ hideLoading(); toast('Đã lưu', 'success'); form.reset(); render(); }, 400);
});

search.addEventListener('input', render);

function render(){
  const app = load();
  let list = app.inventory||[];
  const q = search.value.trim().toLowerCase();
  if(q) list = list.filter(i => [i.model,i.serial,i.location].filter(Boolean).join(' ').toLowerCase().includes(q));
  tbl.innerHTML = list.slice(0,200).map(i=>`
    <tr class="border-b">
      <td class="p-2">${i.date}</td>
      <td class="p-2">${i.model}</td>
      <td class="p-2">${i.serial||''}</td>
      <td class="p-2">${i.type}</td>
      <td class="p-2">${i.type==='out'? '-'+i.outQty : (i.type==='in'? '+'+i.inQty : i.adjQty)}</td>
      <td class="p-2">${i.balance}</td>
    </tr>
  `).join('');
}
render();
"""
(modules / "inventory.js").write_text(textwrap.dedent(inventory_js), encoding="utf-8")

finance_js = """
import { seedIfEmpty, load, save } from '../core/storage.js';
import { insertHeaderNav, showLoading, hideLoading, toast } from '../core/ui.js';
import { guard } from '../core/auth.js';
import { makeId } from '../core/utils.js';

seedIfEmpty();
insertHeaderNav('finance');
guard();

const content = document.getElementById('page-content');
content.innerHTML = `
  <div class="container-narrow mx-auto">
    <div class="card mb-4">
      <div class="card-header">Thu & Chi</div>
      <form id="finForm">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div><label class="k-label">Ngày</label><input class="k-input" type="date" name="date" required></div>
          <div>
            <label class="k-label">Loại</label>
            <select class="k-select" name="type"><option value="income">Thu</option><option value="expense">Chi</option></select>
          </div>
          <div><label class="k-label">Danh mục</label><input class="k-input" name="category" placeholder="VD: Bán hàng, Marketing"></div>
          <div class="md:col-span-2"><label class="k-label">Tiêu đề</label><input class="k-input" name="title"></div>
          <div><label class="k-label">Số tiền</label><input class="k-input" name="amount" type="number" required></div>
          <div class="md:col-span-3"><label class="k-label">Ghi chú</label><input class="k-input" name="note"></div>
        </div>
        <div class="mt-4 flex gap-2">
          <button class="k-btn k-btn-primary" type="submit">Lưu</button>
          <button class="k-btn k-btn-outline" type="reset">Xoá form</button>
        </div>
      </form>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card">
        <div class="card-header">Danh sách Thu/Chi</div>
        <div class="filter-bar mb-3 flex gap-2">
          <input id="search" class="k-input" placeholder="Tìm theo tiêu đề/danh mục">
        </div>
        <div class="overflow-auto"><table class="w-full text-sm"><thead><tr class="text-left border-b"><th class="p-2">Ngày</th><th class="p-2">Loại</th><th class="p-2">Danh mục</th><th class="p-2">Tiêu đề</th><th class="p-2">Số tiền</th></tr></thead><tbody id="tblFin"></tbody></table></div>
      </div>
      <div class="card">
        <div class="card-header">Biểu đồ 6 tháng gần nhất</div>
        <canvas id="chartFin"></canvas>
      </div>
    </div>
  </div>
`;

const form = document.getElementById('finForm');
const tbl = document.getElementById('tblFin');
const search = document.getElementById('search');
form.date.value = new Date().toISOString().slice(0,10);

form.addEventListener('submit', (e)=>{
  e.preventDefault(); showLoading('Đang lưu thu/chi…');
  const app = load();
  const it = { id: makeId('F'), date: form.date.value, type: form.type.value, category: form.category.value, title: form.title.value, amount: Number(form.amount.value||0), note: form.note.value };
  app.finance = app.finance || []; app.finance.unshift(it); save(app);
  setTimeout(()=>{ hideLoading(); toast('Đã lưu', 'success'); form.reset(); render(); }, 400);
});

search.addEventListener('input', render);

function render(){
  const app = load();
  let list = app.finance||[];
  const q = search.value.trim().toLowerCase();
  if(q) list = list.filter(f => [f.title,f.category,f.type].filter(Boolean).join(' ').toLowerCase().includes(q));
  tbl.innerHTML = list.slice(0,200).map(f=>`
    <tr class="border-b">
      <td class="p-2">${f.date}</td>
      <td class="p-2">${f.type==='income'?'Thu':'Chi'}</td>
      <td class="p-2">${f.category||''}</td>
      <td class="p-2">${f.title||''}</td>
      <td class="p-2">${(f.amount||0).toLocaleString('vi-VN')}</td>
    </tr>
  `).join('');

  // chart
  const months = Array.from({length: 6}, (_,i)=>{ const d=new Date(); d.setMonth(d.getMonth()-(5-i)); return d.toISOString().slice(0,7); });
  const income = months.map(m => list.filter(x=>x.type==='income' && x.date?.startsWith(m)).reduce((s,x)=>s+(x.amount||0),0));
  const expense = months.map(m => list.filter(x=>x.type==='expense' && x.date?.startsWith(m)).reduce((s,x)=>s+(x.amount||0),0));
  const ctx = document.getElementById('chartFin').getContext('2d');
  new Chart(ctx, { type:'line', data:{ labels: months, datasets:[ {label:'Thu', data: income, borderWidth:2, tension:.25}, {label:'Chi', data: expense, borderWidth:2, tension:.25} ] } });
}
render();
"""
(modules / "finance.js").write_text(textwrap.dedent(finance_js), encoding="utf-8")

system_js = """
import { seedIfEmpty, load, save, exportJSON, importJSONText } from '../core/storage.js';
import { insertHeaderNav, showLoading, hideLoading, toast } from '../core/ui.js';
import { guard, isAdmin } from '../core/auth.js';
import { makeId } from '../core/utils.js';

seedIfEmpty();
insertHeaderNav('system');
guard('admin');

const content = document.getElementById('page-content');
content.innerHTML = `
  <div class="container-narrow mx-auto space-y-4">
    <div class="card">
      <div class="card-header">Thông báo nội bộ</div>
      <div class="flex gap-2 mb-3" data-role="adminOnly">
        <input id="notiMsg" class="k-input flex-1" placeholder="Nội dung thông báo">
        <select id="notiLevel" class="k-select w-40"><option value="info">Info</option><option value="warn">Warn</option><option value="error">Error</option></select>
        <button id="btnAddNoti" class="k-btn k-btn-primary">Gửi</button>
      </div>
      <ul id="notiList" class="space-y-2"></ul>
    </div>

    <div class="card" data-role="adminOnly">
      <div class="card-header">Người dùng</div>
      <div class="flex gap-2 mb-3">
        <input id="uName" class="k-input" placeholder="Username">
        <input id="uPass" class="k-input" placeholder="Mật khẩu">
        <select id="uRole" class="k-select"><option value="staff">staff</option><option value="admin">admin</option></select>
        <button id="btnAddUser" class="k-btn k-btn-primary">Thêm</button>
      </div>
      <div id="userList" class="text-sm"></div>
    </div>

    <div class="card" data-role="adminOnly">
      <div class="card-header">Cài đặt thương hiệu & nhân sự</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="k-label">Gold</label><input id="gold" class="k-input" value="#F6C90E"></div>
        <div><label class="k-label">Blue</label><input id="blue" class="k-input" value="#0F52BA"></div>
        <div class="flex items-end"><button id="btnApplyBrand" class="k-btn k-btn-outline">Áp dụng</button></div>
      </div>
      <div class="mt-3">
        <label class="k-label">Nhân viên (mỗi tên 1 dòng)</label>
        <textarea id="employees" class="k-input" rows="5"></textarea>
      </div>
      <div class="mt-3 flex gap-2">
        <button id="btnSaveSettings" class="k-btn k-btn-primary">Lưu cài đặt</button>
      </div>
    </div>

    <div class="card" data-role="adminOnly">
      <div class="card-header">Sao lưu & Phục hồi</div>
      <div class="flex gap-2">
        <button id="btnExport" class="k-btn k-btn-outline">Xuất JSON</button>
        <input id="importFile" type="file" accept="application/json" class="k-input">
        <button id="btnImport" class="k-btn k-btn-primary">Nhập JSON</button>
      </div>
    </div>
  </div>
`;

// Notification
document.getElementById('btnAddNoti')?.addEventListener('click', ()=>{
  const msg = document.getElementById('notiMsg').value.trim();
  const level = document.getElementById('notiLevel').value;
  if(!msg) return;
  const app = load(); app.notifications = app.notifications||[];
  app.notifications.unshift({ id: makeId('N'), createdAt: new Date().toISOString(), type:'system', level, message: msg, read:false });
  save(app); toast('Đã gửi thông báo', 'success'); render();
});

function renderNoti(){
  const app = load();
  document.getElementById('notiList').innerHTML = (app.notifications||[]).map(n=>`
    <li class="p-3 rounded-xl border" style="border-color: rgba(0,0,0,.08)">
      <div class="text-xs text-gray-500">${new Date(n.createdAt).toLocaleString('vi-VN')}</div>
      <div class="${n.level==='warn'?'text-amber-600': n.level==='error'?'text-red-600':'text-brand-blue'}">${n.message}</div>
    </li>
  `).join('');
}

// Users
async function addUser(){
  const name = document.getElementById('uName').value.trim();
  const pass = document.getElementById('uPass').value;
  const role = document.getElementById('uRole').value;
  if(!name||!pass) return;
  const { sha256Hex } = await import('../core/auth.js');
  const ph = await sha256Hex(pass);
  const app = load(); app.users = app.users||[];
  app.users.push({ id: makeId('U'), username:name, passHash:ph, role, displayName:name, active:true });
  save(app); toast('Đã thêm user', 'success'); renderUsers();
}
document.getElementById('btnAddUser')?.addEventListener('click', addUser);

function renderUsers(){
  const app = load();
  document.getElementById('userList').innerHTML = (app.users||[]).map(u=>`
    <div class="flex items-center gap-2 py-1 border-b">
      <div class="w-32 font-medium">${u.username}</div>
      <div class="w-20">${u.role}</div>
      <div class="flex-1">${u.active?'Hoạt động':'Khoá'}</div>
    </div>
  `).join('');
}

// Settings
document.getElementById('btnApplyBrand')?.addEventListener('click', ()=>{
  document.documentElement.style.setProperty('--brand-gold', document.getElementById('gold').value || '#F6C90E');
  document.documentElement.style.setProperty('--brand-blue', document.getElementById('blue').value || '#0F52BA');
  toast('Đã áp dụng màu tạm thời', 'info');
});

document.getElementById('btnSaveSettings')?.addEventListener('click', ()=>{
  const app = load();
  app.settings = app.settings || {};
  app.settings.brand = { gold: document.getElementById('gold').value||'#F6C90E', blue: document.getElementById('blue').value||'#0F52BA' };
  app.settings.employees = document.getElementById('employees').value.split('\\n').map(x=>x.trim()).filter(Boolean);
  save(app); toast('Đã lưu cài đặt', 'success');
});

// Backup/Restore
document.getElementById('btnExport')?.addEventListener('click', ()=>{
  const blob = exportJSON();
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='klc_app_backup.json'; a.click();
  URL.revokeObjectURL(url);
});
document.getElementById('btnImport')?.addEventListener('click', async ()=>{
  const f = document.getElementById('importFile').files?.[0];
  if(!f) return;
  const txt = await f.text();
  const ok = importJSONText(txt);
  toast(ok?'Nhập dữ liệu thành công':'Tệp không hợp lệ', ok?'success':'error');
});

function initSettingsUI(){
  const app = load();
  document.getElementById('gold').value = app.settings?.brand?.gold || '#F6C90E';
  document.getElementById('blue').value = app.settings?.brand?.blue || '#0F52BA';
  document.getElementById('employees').value = (app.settings?.employees||[]).join('\\n');
}
function render(){ renderNoti(); renderUsers(); initSettingsUI(); }
render();
"""
(modules / "system.js").write_text(textwrap.dedent(system_js), encoding="utf-8")

# ---------- HTML files ----------
# Common HTML header template
def html_page(title, active, extra_head="", extra_scripts="", body_inner=""):
    return f"""<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{title} - KLC Bến Lức</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="assets/css/brand.css">
  {extra_head}
</head>
<body>
  <div id="global-loading"></div>
  <div id="toast-area"></div>
  <div id="app-shell"></div>
  <div id="__page_mount"></div>
  <script type="module">
    import {{ insertHeaderNav }} from './js/core/ui.js';
    import {{ guard }} from './js/core/auth.js';
    import {{ seedIfEmpty }} from './js/core/storage.js';
    seedIfEmpty(); insertHeaderNav('{active}'); guard();
  </script>
  {extra_scripts}
  {body_inner}
</body>
</html>"""

# index.html (Login)
index_html = f"""<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Đăng nhập - KLC Bến Lức</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="assets/css/brand.css">
</head>
<body class="bg-gray-50">
  <div id="global-loading"></div>
  <div id="toast-area"></div>
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6">
      <div class="flex items-center gap-3 mb-4">
        <img src="assets/img/logo.png" class="w-12 h-12 rounded-xl shadow" alt="KLC">
        <div>
          <div class="text-xl font-bold">KLC Bến Lức – Nội bộ</div>
          <div class="text-xs text-gray-500">Đăng nhập để tiếp tục</div>
        </div>
      </div>
      <form id="loginForm" class="space-y-3">
        <div>
          <label class="k-label">Tài khoản</label>
          <input class="k-input" name="username" placeholder="admin / nhanvien" required>
        </div>
        <div>
          <label class="k-label">Mật khẩu</label>
          <input class="k-input" type="password" name="password" placeholder="••••••" required>
        </div>
        <div class="flex items-center justify-between">
          <label class="flex items-center gap-2"><input type="checkbox" name="remember"> Nhớ mật khẩu</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="keep"> Duy trì đăng nhập (30 ngày)</label>
        </div>
        <button class="k-btn k-btn-primary w-full" type="submit">Đăng nhập</button>
        <p class="text-xs text-gray-500 mt-2">⚠️ Ứng dụng nội bộ chạy LocalStorage. Không dùng cho dữ liệu nhạy cảm trên internet công cộng.</p>
        <div class="text-xs text-gray-400">Demo: admin / {ADMIN_PASS} • nhanvien / {STAFF_PASS}</div>
      </form>
    </div>
  </div>
  <script type="module">
    import {{ login }} from './js/core/auth.js';
    import {{ showLoading, hideLoading, toast }} from './js/core/ui.js';
    import {{ seedIfEmpty }} from './js/core/storage.js';
    seedIfEmpty();
    const form = document.getElementById('loginForm');
    form.addEventListener('submit', async (e)=>{ 
      e.preventDefault(); showLoading('Đang đăng nhập…');
      const ok = await login(form.username.value.trim(), form.password.value, form.remember.checked, form.keep.checked);
      setTimeout(hideLoading, 500);
      if(!ok) hideLoading();
    });
  </script>
</body>
</html>
"""
(base / "index.html").write_text(index_html, encoding="utf-8")

# Other pages HTML
dashboard_html = html_page("Trang chủ", "dashboard", extra_scripts='<script type="module" src="js/modules/dashboard.js"></script>')
(base / "dashboard.html").write_text(dashboard_html, encoding="utf-8")

customers_html = html_page("Khách hàng", "customers", extra_scripts='<script type="module" src="js/modules/customers.js"></script>')
(base / "customers.html").write_text(customers_html, encoding="utf-8")

care_html = html_page("CSKH", "care", extra_scripts='<script type="module" src="js/modules/care.js"></script>')
(base / "care.html").write_text(care_html, encoding="utf-8")

service_html = html_page("Bảo hành & Bảo dưỡng", "service", extra_scripts='<script type="module" src="js/modules/service.js"></script>')
(base / "service.html").write_text(service_html, encoding="utf-8")

checklist_html = html_page("CheckList Công Việc", "checklist", extra_scripts='<script type="module" src="js/modules/checklist.js"></script>')
(base / "checklist.html").write_text(checklist_html, encoding="utf-8")

inventory_html = html_page("Tồn kho", "inventory", extra_scripts='<script type="module" src="js/modules/inventory.js"></script>')
(base / "inventory.html").write_text(inventory_html, encoding="utf-8")

finance_html = html_page("Thu & Chi", "finance", extra_scripts='<script type="module" src="js/modules/finance.js"></script>')
(base / "finance.html").write_text(finance_html, encoding="utf-8")

system_html = html_page("Thông báo/Hệ thống", "system", extra_scripts='<script type="module" src="js/modules/system.js"></script>')
(base / "system.html").write_text(system_html, encoding="utf-8")

# 404.html (simple fallback)
(base / "404.html").write_text("""<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>KLC - 404</title><script src="https://cdn.tailwindcss.com"></script><link rel="stylesheet" href="assets/css/brand.css"></head>
<body class="min-h-screen flex items-center justify-center bg-gray-50">
  <div class="text-center
