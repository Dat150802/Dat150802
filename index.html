<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KLC Bến Lức</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- PapaParse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root { --klc-blue:#1f4b99; }
    body { background:#f7f9fc; }
    .klc-navbar { background: linear-gradient(90deg, var(--klc-blue), #0a2f6b); }
    .klc-navbar .navbar-brand, .klc-navbar .nav-link, .klc-navbar .navbar-text { color:#fff !important; }
    .card { border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .btn-klc { background:var(--klc-blue); color:#fff; }
    .btn-klc:hover { opacity:.9; color:#fff; }
    .hidden { display:none!important; }
    .small-scroll { max-height:420px; overflow:auto; }
    .kpi { font-size: 1.75rem; font-weight: 700; }
    .form-inline > * { margin-right: .5rem; }
    code, pre { user-select:text; }
    .muted { color: #6c757d; }
  </style>
</head>
<body>
  <nav class="navbar klc-navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">KLC Bến Lức</a>
      <div class="ms-auto d-flex align-items-center gap-3">
        <span id="meBox" class="navbar-text small"></span>
      </div>
    </div>
  </nav>

  <div class="container py-4">

    <!-- Signed-out -->
    <div id="signedOut" class="text-center py-5">
      <h4 class="mb-3">Đăng nhập Google để tiếp tục</h4>
      <div id="gbtnWrap" class="d-inline-block"></div>
      <div id="debug" class="small text-danger mt-2"></div>
      <p class="text-muted mt-3">Tài khoản phải có trong sheet <code>users</code> (status=active).</p>
    </div>

    <!-- App -->
    <div id="app" class="hidden">
      <!-- Menu -->
      <ul class="nav nav-pills mb-3" id="menu">
        <li class="nav-item"><a class="nav-link active" data-section="dashboard" href="#">Trang chủ</a></li>
        <li class="nav-item"><a class="nav-link" data-section="customers" href="#">Khách hàng</a></li>
      </ul>

      <!-- DASHBOARD -->
      <section id="section-dashboard">
        <div class="card p-3 mb-3">
          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-2">
              <label class="form-label mb-1">Tháng</label>
              <input id="dashMonth" type="number" min="1" max="12" class="form-control" />
            </div>
            <div class="col-12 col-md-2">
              <label class="form-label mb-1">Năm</label>
              <input id="dashYear" type="number" min="2000" max="2100" class="form-control" />
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label mb-1">Từ ngày (dd/MM/yyyy)</label>
              <input id="fromDate" class="form-control" placeholder="dd/MM/yyyy" />
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label mb-1">Đến ngày (dd/MM/yyyy)</label>
              <input id="toDate" class="form-control" placeholder="dd/MM/yyyy" />
            </div>
            <div class="col-12 col-md-2">
              <button class="btn btn-klc w-100" id="btnDashLoad">Xem</button>
            </div>
          </div>
          <div class="small mt-2 muted">Ưu tiên lọc theo khoảng <b>Từ ngày</b> – <b>Đến ngày</b> nếu có; nếu để trống sẽ lọc theo Tháng/Năm.</div>
        </div>

        <div class="row g-3" id="kpiRow">
          <div class="col-md-3">
            <div class="card p-3">
              <div class="muted small">Khách mới</div>
              <div id="kpiKhachMoi" class="kpi">0</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3">
              <div class="muted small">Đã mua</div>
              <div id="kpiDaMua" class="kpi">0</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3">
              <div class="muted small">Chưa mua</div>
              <div id="kpiChuaMua" class="kpi">0</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card p-3">
              <div class="muted small">CSKH (phiên)</div>
              <div id="kpiCSKH" class="kpi">0</div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-md-6">
            <div class="card p-3">
              <div class="fw-bold mb-2">Khách mới theo ngày</div>
              <canvas id="chartKhachMoi" height="140"></canvas>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card p-3">
              <div class="fw-bold mb-2">Thu / Chi theo ngày</div>
              <canvas id="chartFinance" height="140"></canvas>
            </div>
          </div>
        </div>

        <pre class="mt-3 small text-muted" id="dashRaw"></pre>
      </section>

      <!-- CUSTOMERS -->
      <section id="section-customers" class="hidden">
        <div class="card p-3 mb-3">
          <div class="row g-2 align-items-end">
            <div class="col-6 col-md-2">
              <label class="form-label mb-1">Tháng</label>
              <input id="cl_month" type="number" min="1" max="12" class="form-control">
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label mb-1">Năm</label>
              <input id="cl_year" type="number" min="2000" max="2100" class="form-control">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label mb-1">Tìm theo tên/điện thoại</label>
              <input id="c_search" class="form-control" placeholder="VD: An / 09xx...">
            </div>
            <div class="col-12 col-md-2">
              <button class="btn btn-klc w-100" id="btnCusLoad">Tìm kiếm</button>
            </div>
          </div>
        </div>

        <div class="card p-3">
          <div id="c_list" class="small small-scroll"></div>
        </div>
      </section>
    </div>
  </div>

<script>
/* ========= CONFIG ========= */
const GOOGLE_CLIENT_ID = "229964671691-jvq8pstlajqa9v6g0rhfi0u8ei39453u.apps.googleusercontent.com";
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxscUm2o0q70dsQm3mERQyyZWejd2TmQREfqXZ6qkbQtQYx-OWuB5BDFmBpBJj6_ebw/exec";

let ID_TOKEN = "";
let ME = null;

/* ========= HELPERS ========= */
function dlog(m){ const e=document.getElementById('debug'); if(e) e.textContent=m; console.error(m); }
function byId(id){ return (document.getElementById(id).value||"").trim(); }
function pad2(n){ return String(n).padStart(2,'0'); }
function parseDDMMYYYY(s){
  if(!s) return null;
  const [dd,mm,yyyy] = s.split('/').map(x=>parseInt(x,10));
  if(!dd||!mm||!yyyy) return null;
  return new Date(yyyy, mm-1, dd);
}
function yyyymmdd(d){
  return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
}
function inRange(d, fromStr, toStr, month, year){
  if(!(d instanceof Date)) return false;
  if (fromStr && toStr){
    const f = parseDDMMYYYY(fromStr);
    const t = parseDDMMYYYY(toStr);
    if(!f || !t) return false;
    const t1 = new Date(t.getFullYear(), t.getMonth(), t.getDate()+1);
    return d >= f && d < t1;
  }
  if (month && (d.getMonth()+1) !== Number(month)) return false;
  if (year  && d.getFullYear()  !== Number(year))  return false;
  return true;
}
function decodeB64ToText(b64){
  const bin = atob(b64);
  const bytes = Uint8Array.from(bin, ch=>ch.charCodeAt(0));
  return new TextDecoder('utf-8').decode(bytes);
}

/* ========= LOGIN ========= */
window.onload = function(){
  try{
    if (!window.google || !google.accounts || !google.accounts.id){
      dlog('Không tải được Google Sign-In. Kiểm tra mạng/extension chặn script.');
      return;
    }
    google.accounts.id.initialize({
      client_id: GOOGLE_CLIENT_ID,
      callback: onCredentialResponse,
      auto_select: false,
      cancel_on_tap_outside: true
    });
    google.accounts.id.renderButton(
      document.getElementById("gbtnWrap"),
      { theme: "outline", size: "large", width: 250 }
    );
  }catch(e){ dlog('Lỗi init GIS: ' + e); }
};

function onCredentialResponse(resp){
  ID_TOKEN = resp.credential || "";
  postLogin();
}

async function callApi(action, payload){
  const res = await fetch(WEB_APP_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ action, payload, id_token: ID_TOKEN })
  });
  const j = await res.json();
  if (!j.ok) throw new Error(j.error||'API_ERROR');
  return j.data;
}

function bindMenu(){
  document.querySelectorAll('#menu .nav-link').forEach(a=>{
    a.onclick = (e)=>{
      e.preventDefault();
      document.querySelectorAll('#menu .nav-link').forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
      const sec = a.getAttribute('data-section');
      document.querySelectorAll('section[id^="section-"]').forEach(s=>s.classList.add('hidden'));
      document.getElementById('section-'+sec).classList.remove('hidden');
    };
  });
}

/* ========= AFTER LOGIN ========= */
async function postLogin(){
  try{
    // gọi API đơn giản để xác thực và lấy role (nếu back-end hỗ trợ)
    try{
      const me = await callApi("me", {});
      ME = me;
      document.getElementById("meBox").textContent = (me && me.email) ? (me.email + (me.role? " ("+me.role+")": "")) : "";
    }catch(_){ /* nếu BE không có 'me' thì vẫn tiếp tục */}

    document.getElementById("signedOut").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");

    // defaults
    const now = new Date();
    document.getElementById("dashMonth").value = now.getMonth()+1;
    document.getElementById("dashYear").value  = now.getFullYear();
    document.getElementById("cl_month").value  = now.getMonth()+1;
    document.getElementById("cl_year").value   = now.getFullYear();

    bindMenu();
    document.getElementById("btnDashLoad").onclick = loadDashboard;
    document.getElementById("btnCusLoad").onclick  = loadCustomers;

    await loadDashboard();
  }catch(e){
    alert("Đăng nhập thất bại: " + e.message);
  }
}

/* ========= EXPORT CSV HELPERS ========= */
async function getCsv(sheet){
  const r = await callApi("export.csv", {sheet});
  const txt = decodeB64ToText(r.base64 || "");
  // parse via Papa
  const parsed = Papa.parse(txt, {header:true, skipEmptyLines:true});
  return parsed.data || [];
}

/* ========= DASHBOARD ========= */
let chartKM = null, chartFin = null;

async function loadDashboard(){
  try{
    const m = Number(document.getElementById("dashMonth").value || 0);
    const y = Number(document.getElementById("dashYear").value  || 0);
    const f = byId("fromDate");
    const t = byId("toDate");

    // lấy dữ liệu thô
    const [customers, cskh, finance] = await Promise.all([
      getCsv("customers"),
      getCsv("cskh"),
      getCsv("finance"),
    ]);

    // lọc theo thời gian
    const toDateObj = s => (s ? parseDDMMYYYY(s) : null);
    const toDateField = v => (v instanceof Date ? v : (v && v.includes('/') ? parseDDMMYYYY(v) : (v ? new Date(v) : null)));

    const cusFiltered = customers.filter(row => {
      const d = toDateField(row.ngay);
      return d && inRange(d, f, t, m, y);
    });

    const cskhFiltered = cskh.filter(row => {
      const d = toDateField(row.ngay);
      return d && inRange(d, f, t, m, y);
    });

    const finFiltered = finance.filter(row => {
      const d = toDateField(row.ngay);
      return d && inRange(d, f, t, m, y);
    });

    // KPI
    const khachMoi = cusFiltered.length;
    const daMua = cusFiltered.reduce((acc, r)=> acc + (String(r.trang_thai_mua)==='Đã mua' ? 1:0), 0);
    const chuaMua = khachMoi - daMua;
    const soPhienCSKH = cskhFiltered.length;

    document.getElementById("kpiKhachMoi").textContent = khachMoi;
    document.getElementById("kpiDaMua").textContent   = daMua;
    document.getElementById("kpiChuaMua").textContent = chuaMua;
    document.getElementById("kpiCSKH").textContent    = soPhienCSKH;

    // Biểu đồ Khách mới theo ngày
    const kmByDay = {};
    cusFiltered.forEach(r=>{
      const d = toDateField(r.ngay);
      const key = yyyymmdd(d);
      kmByDay[key] = (kmByDay[key]||0)+1;
    });
    const kmLabels = Object.keys(kmByDay).sort();
    const kmData   = kmLabels.map(k=>kmByDay[k]);

    if (chartKM) chartKM.destroy();
    chartKM = new Chart(document.getElementById('chartKhachMoi'), {
      type: 'bar',
      data: { labels: kmLabels, datasets: [{ label: 'Khách mới', data: kmData }]},
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{maxRotation:0}}} }
    });

    // Biểu đồ Thu/Chi theo ngày
    const finByDay = {};
    finFiltered.forEach(r=>{
      const d = toDateField(r.ngay);
      const key = yyyymmdd(d);
      if(!finByDay[key]) finByDay[key] = {Thu:0, Chi:0};
      const v = Number(r.so_tien||0);
      const loai = String(r.loai||"");
      if (loai==="Thu") finByDay[key].Thu += v; else finByDay[key].Chi += v;
    });
    const fLabels = Object.keys(finByDay).sort();
    const fThu = fLabels.map(k=>finByDay[k].Thu);
    const fChi = fLabels.map(k=>finByDay[k].Chi);

    if (chartFin) chartFin.destroy();
    chartFin = new Chart(document.getElementById('chartFinance'), {
      type: 'line',
      data: { labels: fLabels, datasets: [
        { label:'Thu', data: fThu, tension:0.2 },
        { label:'Chi', data: fChi, tension:0.2 },
      ]},
      options: { responsive:true, maintainAspectRatio:false, scales:{x:{ticks:{maxRotation:0}}} }
    });

    // Raw debug
    const rawBox = document.getElementById("dashRaw");
    rawBox.textContent = JSON.stringify({ filters:{month:m,year:y,from:f,to:t}, counts:{
      customers: cusFiltered.length, cskh: cskhFiltered.length, finance: finFiltered.length
    }}, null, 2);
  }catch(e){
    alert("Lỗi tải Trang chủ: " + e.message);
  }
}

/* ========= CUSTOMERS ========= */
async function loadCustomers(){
  try{
    const m = Number(document.getElementById("cl_month").value || 0);
    const y = Number(document.getElementById("cl_year").value  || 0);
    const q = (document.getElementById("c_search").value||"").trim().toLowerCase();

    const rows = await getCsv("customers");
    // lọc theo tháng/năm chính xác ở client
    const filtered = rows.filter(r=>{
      const d = r.ngay && r.ngay.includes('/') ? parseDDMMYYYY(r.ngay) : (r.ngay ? new Date(r.ngay) : null);
      if(!d) return false;
      if (m && (d.getMonth()+1)!==m) return false;
      if (y && d.getFullYear() !== y) return false;
      const name = String(r.ten||"").toLowerCase();
      const phone = String(r.so_dien_thoai||"");
      if (!q) return true;
      return name.includes(q) || phone.includes(q);
    });

    const html = filtered.map(x=>{
      return `<div class="border rounded p-2 mb-2">
        <div class="d-flex justify-content-between">
          <div><b>${x.ten||"-"}</b> • ${x.so_dien_thoai||"-"} • ${x.nguon_khach||"-"} • ${x.trang_thai_mua||"-"} • ${x.mau_ghe||""}</div>
          <div class="small text-muted">${x.ngay||""}</div>
        </div>
        <div class="mt-1">${x.dia_chi||""}</div>
      </div>`;
    }).join("");
    document.getElementById("c_list").innerHTML = html || "<div class='text-muted'>Không có dữ liệu</div>";
  }catch(e){
    alert("Lỗi tải Khách hàng: " + e.message);
  }
}

</script>
</body>
</html>
