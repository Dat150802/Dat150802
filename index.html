<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>KLC Nội bộ – Bến Lức</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{border:1px solid #e5e7eb;border-radius:1rem;background:#fff;box-shadow:0 8px 24px rgba(0,0,0,.05)}
    .input{height:2.6rem;width:100%;padding:.55rem .75rem;border:1px solid #e5e7eb;border-radius:.6rem}
    .btn{display:inline-flex;align-items:center;gap:.5rem;height:2.6rem;padding:0 .9rem;border-radius:.75rem;border:1px solid #e5e7eb}
    .btn-primary{background:#10b981;color:#fff;border-color:#10b981}
    .btn-outline{background:#fff}
    .error{display:none;margin-top:.5rem;border:1px solid #fecaca;background:#fef2f2;color:#991b1b;padding:.5rem;border-radius:.5rem}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="font-bold text-lg" id="brandTitle">KLC Nội bộ – Bến Lức</div>
      <nav class="hidden md:flex gap-2 text-sm">
        <a href="#cskh" class="px-3 py-2 rounded-lg hover:bg-emerald-50 hover:text-emerald-700">CSKH</a>
        <a href="#warranty" class="px-3 py-2 rounded-lg hover:bg-emerald-50 hover:text-emerald-700">Bảo hành</a>
        <a href="#settings" class="px-3 py-2 rounded-lg hover:bg-emerald-50 hover:text-emerald-700" data-admin>Cài đặt</a>
      </nav>
      <div class="flex items-center gap-2">
        <span id="whoami" class="text-xs text-gray-500"></span>
        <button class="btn btn-primary" onclick="openLogin()">Đăng nhập</button>
        <button class="btn btn-outline" onclick="doLogout()">Đăng xuất</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">

    <!-- CSKH -->
    <section id="cskh" class="mt-4">
      <div class="text-xl font-semibold mb-3">CSKH</div>

      <div class="grid md:grid-cols-2 gap-3">
        <input id="c_name" class="input" placeholder="Khách hàng">
        <input id="c_phone" class="input" placeholder="SĐT">
      </div>
      <input id="c_need" class="input mt-3" placeholder="Nhu cầu (mua/đổi/bảo dưỡng...)">
      <div class="grid md:grid-cols-2 gap-3 mt-3">
        <input id="c_source" class="input" placeholder="Nguồn khách (FB/Zalo/KH cũ/...)">
        <input id="c_address" class="input" placeholder="Địa chỉ khách">
      </div>
      <div class="mt-3 flex flex-wrap gap-4 text-sm">
        <label><input type="checkbox" id="c_potential"> Còn tiềm năng</label>
        <label><input type="checkbox" id="c_noPotential"> Hết tiềm năng</label>
        <label><input type="checkbox" id="c_nurturing"> Đang nuôi khách</label>
        <label><input type="checkbox" id="c_scheduledUp"> Đang hẹn lên</label>
      </div>
      <div class="mt-3 flex gap-2">
        <button class="btn btn-primary" onclick="saveCare()">Lưu</button>
        <button class="btn btn-outline" onclick="loadCare()">Tải lại</button>
      </div>

      <!-- gợi ý khách -->
      <ul id="c_hints" class="mt-2 bg-white border rounded hidden max-h-56 overflow-auto"></ul>

      <!-- bảng -->
      <div class="card p-4 mt-6">
        <div class="font-semibold mb-2">Nhật ký CSKH</div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-gray-500">
              <tr>
                <th class="text-left p-2">Ngày</th>
                <th class="text-left p-2">Khách</th>
                <th class="text-left p-2">SĐT</th>
                <th class="text-left p-2">Nhu cầu</th>
                <th class="text-left p-2">Nguồn</th>
                <th class="text-left p-2">Địa chỉ</th>
                <th class="text-left p-2">Trạng thái</th>
              </tr>
            </thead>
            <tbody id="c_tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Bảo hành -->
    <section id="warranty" class="mt-12">
      <div class="text-xl font-semibold mb-3">Bảo hành</div>

      <div class="grid md:grid-cols-2 gap-3">
        <input id="w_name" class="input" placeholder="Khách hàng">
        <input id="w_phone" class="input" placeholder="SĐT">
      </div>
      <input id="w_address" class="input mt-3" placeholder="Địa chỉ đặt ghế">
      <input id="w_issue"   class="input mt-3" placeholder="Tình trạng khách cần hỗ trợ">
      <div class="mt-3 flex gap-4 text-sm">
        <label><input type="checkbox" id="w_isWarranty"> Bảo hành</label>
        <label><input type="checkbox" id="w_isMaintenance"> Bảo dưỡng</label>
      </div>
      <div class="mt-3 flex gap-2">
        <button class="btn btn-primary" onclick="saveWarranty()">Lưu</button>
        <button class="btn btn-outline" onclick="loadWarranty()">Tải lại</button>
      </div>

      <ul id="w_hints" class="mt-2 bg-white border rounded hidden max-h-56 overflow-auto"></ul>

      <div class="card p-4 mt-6">
        <div class="font-semibold mb-2">Danh sách bảo hành</div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-gray-500">
              <tr>
                <th class="text-left p-2">Ngày</th>
                <th class="text-left p-2">Khách</th>
                <th class="text-left p-2">SĐT</th>
                <th class="text-left p-2">Địa chỉ đặt ghế</th>
                <th class="text-left p-2">Tình trạng hỗ trợ</th>
                <th class="text-left p-2">BH</th>
                <th class="text-left p-2">Bảo dưỡng</th>
              </tr>
            </thead>
            <tbody id="w_tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Cài đặt (chỉ admin) -->
    <section id="settings" data-admin class="card p-4 mt-12">
      <div class="text-lg font-semibold mb-2">Cài đặt</div>
      <div class="grid md:grid-cols-3 gap-3">
        <div class="col-span-2 flex gap-2 items-center">
          <input id="cfg_api" class="input" placeholder="Dán YOUR_EXEC_URL (…/exec)">
          <button class="btn btn-primary" onclick="saveCfg()">Lưu API</button>
        </div>
        <div class="flex gap-2 items-center">
          <input id="cfg_title" class="input" placeholder="Tiêu đề trang (vd: KLC Nội bộ – Bến Lức)">
          <button class="btn btn-outline" onclick="saveTitle()">Đổi tiêu đề</button>
        </div>
      </div>
      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <div class="flex gap-2 items-center">
          <input id="cfg_color" class="input" placeholder="Màu thương hiệu (vd: #10b981)">
          <button class="btn btn-outline" onclick="saveBrand()">Đổi màu</button>
        </div>
      </div>
      <div class="text-xs text-gray-500 mt-2">Phần này chỉ admin nhìn thấy.</div>
    </section>

  </main>

  <!-- Modal Login -->
  <div id="loginModal" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
    <div class="bg-white p-4 rounded-xl w-[360px]">
      <div class="text-lg font-semibold mb-2">Đăng nhập</div>
      <input id="u_user" class="input mb-2" placeholder="Tài khoản (vd: admin)">
      <input id="u_pass" class="input mb-3" type="password" placeholder="Mật khẩu">
      <div class="flex gap-2 justify-end">
        <button class="btn btn-outline" onclick="closeLogin()">Huỷ</button>
        <button class="btn btn-primary" onclick="doLogin()">Đăng nhập</button>
      </div>
      <div id="loginMsg" class="error mt-2"></div>
    </div>
  </div>

  <!-- Core JS -->
  <script>
  const API   = () => localStorage.getItem('klc_api')  || '';
  const ROLE  = () => localStorage.getItem('klc_role') || 'guest';
  const USER  = () => localStorage.getItem('klc_user') || '';
  function isAdmin(){ return ROLE()==='admin'; }
  function fmt(d){ const x=(d instanceof Date)?d:new Date(d); return x.toISOString().slice(0,10); }
  async function call(action, params={}){
    const usp = new URLSearchParams({action, ...params});
    const r = await fetch(API() + '?' + usp.toString());
    return r.json();
  }

  function applyBrand(){
    const t = localStorage.getItem('klc_title') || 'KLC Nội bộ – Bến Lức';
    const c = localStorage.getItem('klc_color') || '#10b981';
    document.title = t;
    const bt = document.getElementById('brandTitle'); if(bt) bt.textContent = t;
    document.documentElement.style.setProperty('--brand', c);
  }
  function showAdminOnly(){
    document.querySelectorAll('[data-admin]').forEach(el=> el.style.display = isAdmin()? '' : 'none');
    const u = document.getElementById('whoami'); if(u) u.textContent = USER()? (USER()+' • '+ROLE()) : '';
  }

  function openLogin(){ const m=document.getElementById('loginModal'); m.classList.remove('hidden'); m.classList.add('flex'); }
  function closeLogin(){ const m=document.getElementById('loginModal'); m.classList.add('hidden'); m.classList.remove('flex'); }
  async function doLogin(){
    const username = document.getElementById('u_user').value.trim();
    const password = document.getElementById('u_pass').value;
    if(!API()){ alert('Chưa cấu hình API trong Cài đặt.'); return; }
    const js = await call('login', {username, password});
    if(js.ok){
      localStorage.setItem('klc_role', js.role||'staff');
      localStorage.setItem('klc_user', js.user||username);
      closeLogin(); showAdminOnly(); alert('Đăng nhập: '+js.role);
    }else{
      const err = document.getElementById('loginMsg');
      err.textContent = 'Sai tài khoản/mật khẩu'; err.style.display='block';
    }
  }
  function doLogout(){ localStorage.removeItem('klc_role'); localStorage.removeItem('klc_user'); showAdminOnly(); alert('Đã đăng xuất.'); }

  // SETTINGS
  function saveCfg(){ const v=document.getElementById('cfg_api').value.trim(); if(!v){alert('Điền API');return;} localStorage.setItem('klc_api', v); alert('Đã lưu API'); location.reload(); }
  function saveTitle(){ const v=document.getElementById('cfg_title').value.trim(); if(!v){alert('Điền tiêu đề');return;} localStorage.setItem('klc_title', v); applyBrand(); alert('Đã đổi tiêu đề'); }
  function saveBrand(){ const v=document.getElementById('cfg_color').value.trim(); if(!/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(v)){alert('Màu không hợp lệ');return;} localStorage.setItem('klc_color', v); applyBrand(); alert('Đã đổi màu'); }

  // CSKH
  async function saveCare(){
    if(!API()){ alert('Chưa cấu hình API.'); return; }
    const p = {
      customer: document.getElementById('c_name').value.trim(),
      phone:    document.getElementById('c_phone').value.trim(),
      need:     document.getElementById('c_need').value.trim(),
      source:   document.getElementById('c_source').value.trim(),
      address:  document.getElementById('c_address').value.trim(),
      potential:  document.getElementById('c_potential').checked ? '1':'',
      noPotential:document.getElementById('c_noPotential').checked ? '1':'',
      nurturing:  document.getElementById('c_nurturing').checked ? '1':'',
      scheduledUp:document.getElementById('c_scheduledUp').checked ? '1':''
    };
    const js = await call('logCare', p);
    if(js.ok){ alert('Đã lưu.'); loadCare(); } else { alert('Lỗi: '+js.error); }
  }
  async function loadCare(){
    if(!API()) return;
    const js = await call('getCare');
    const tb = document.getElementById('c_tbody'); tb.innerHTML='';
    (js.data||[]).forEach(r=>{
      const st = [
        r.potential?'tiềm năng':'' ,
        r.noPotential?'hết TN':'' ,
        r.nurturing?'nuôi KH':'' ,
        r.scheduledUp?'hẹn lên':''
      ].filter(Boolean).join(', ');
      tb.insertAdjacentHTML('beforeend', `
        <tr class="border-t">
          <td class="p-2">${fmt(r.date)}</td>
          <td class="p-2">${r.customer||''}</td>
          <td class="p-2">${r.phone||''}</td>
          <td class="p-2">${r.need||''}</td>
          <td class="p-2">${r.source||''}</td>
          <td class="p-2">${r.address||''}</td>
          <td class="p-2">${st}</td>
        </tr>`);
    });
  }
  async function hintCustomers(q){
    const ul = document.getElementById('c_hints');
    if(!q || q.length<2){ ul.classList.add('hidden'); return; }
    const js = await call('getCustomerHints', {q});
    ul.innerHTML = (js.data||[]).map(v=>(
      `<li class="px-3 py-2 hover:bg-gray-50 cursor-pointer"
        onclick="pickHint('${encodeURIComponent(v.customer||'')}','${encodeURIComponent(v.phone||'')}','${encodeURIComponent(v.address||'')}','${encodeURIComponent(v.source||'')}')">
        <b>${v.customer||''}</b> • ${v.phone||''}
        <span class="text-xs text-gray-500"> ${v.address||''}</span>
      </li>`
    ).join('');
    ul.classList.remove('hidden');
  }
  function pickHint(n,p,addr,src){
    document.getElementById('c_name').value    = decodeURIComponent(n);
    document.getElementById('c_phone').value   = decodeURIComponent(p);
    document.getElementById('c_address').value = decodeURIComponent(addr);
    document.getElementById('c_source').value  = decodeURIComponent(src);
    document.getElementById('c_hints').classList.add('hidden');
  }
  ['c_name','c_phone'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('input', e=> hintCustomers(e.target.value.trim()));
  });

  // Bảo hành
  async function saveWarranty(){
    if(!API()){ alert('Chưa cấu hình API.'); return; }
    const p = {
      customer: document.getElementById('w_name').value.trim(),
      phone:    document.getElementById('w_phone').value.trim(),
      address:  document.getElementById('w_address').value.trim(),
      issue:    document.getElementById('w_issue').value.trim(),
      isWarranty:    document.getElementById('w_isWarranty').checked ? '1':'',
      isMaintenance: document.getElementById('w_isMaintenance').checked ? '1':''
    };
    const js = await call('logWarranty', p);
    if(js.ok){ alert('Đã lưu bảo hành.'); loadWarranty(); } else { alert('Lỗi: '+js.error); }
  }
  async function loadWarranty(){
    if(!API()) return;
    const js = await call('getWarranty');
    const tb = document.getElementById('w_tbody'); tb.innerHTML='';
    (js.data||[]).forEach(r=>{
      tb.insertAdjacentHTML('beforeend', `
        <tr class="border-t">
          <td class="p-2">${fmt(r.date)}</td>
          <td class="p-2">${r.customer||''}</td>
          <td class="p-2">${r.phone||''}</td>
          <td class="p-2">${r.address||''}</td>
          <td class="p-2">${r.issue||''}</td>
          <td class="p-2">${r.isWarranty ? '✔':''}</td>
          <td class="p-2">${r.isMaintenance ? '✔':''}</td>
        </tr>`);
    });
  }
  async function wHint(q){
    const ul = document.getElementById('w_hints');
    if(!q || q.length<2){ ul.classList.add('hidden'); return; }
    const js = await call('getCustomerHints', {q});
    ul.innerHTML = (js.data||[]).map(v=>(
      `<li class="px-3 py-2 hover:bg-gray-50 cursor-pointer"
        onclick="wPick('${encodeURIComponent(v.customer||'')}','${encodeURIComponent(v.phone||'')}','${encodeURIComponent(v.address||'')}')">
        <b>${v.customer||''}</b> • ${v.phone||''}
        <span class="text-xs text-gray-500"> ${v.address||''}</span>
      </li>`
    ).join('');
    ul.classList.remove('hidden');
  }
  function wPick(n,p,a){
    document.getElementById('w_name').value    = decodeURIComponent(n);
    document.getElementById('w_phone').value   = decodeURIComponent(p);
    document.getElementById('w_address').value = decodeURIComponent(a);
    document.getElementById('w_hints').classList.add('hidden');
  }
  ['w_name','w_phone'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('input', e=> wHint(e.target.value.trim()));
  });

  document.addEventListener('DOMContentLoaded', ()=>{
    applyBrand();
    showAdminOnly();
    if(API()){ loadCare(); loadWarranty(); }
  });
  </script>

</body>
</html>
