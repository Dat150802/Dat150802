<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KLC Bến Lức – Thiết lập hệ thống</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="assets/css/brand.css">
</head>
<body class="bg-slate-100">
<div id="app-loading" class="flex"></div>
<div id="toast-stack" class="fixed top-6 right-6 flex flex-col items-end"></div>
<nav id="app-mobile-nav" class="md:hidden bg-brand-blue"></nav>

<div class="app-shell md:flex">
  <aside id="app-sidebar" class="app-sidebar"></aside>
  <div class="flex-1 min-h-screen flex flex-col">
    <header id="app-topbar" class="flex items-center justify-between px-4 md:px-6 py-4 bg-white border-b"></header>
    <main class="flex-1 p-4 md:p-6 space-y-6">
      <section class="card p-5 space-y-4">
        <div class="section-title">Tài khoản & phân quyền</div>
        <p class="text-sm text-slate-500">Quản trị viên có thể thêm hoặc điều chỉnh tài khoản truy cập hệ thống.</p>
        <div id="system-warning" class="hidden text-sm text-amber-600 font-semibold">Bạn không có quyền chỉnh sửa thiết lập hệ thống.</div>
        <div id="system-form-wrapper" class="space-y-4">
          <form id="user-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="flex flex-col">
              <span class="text-xs text-slate-500">Tên đăng nhập</span>
              <input type="text" name="username" class="input-brand" required>
            </label>
            <label class="flex flex-col">
              <span class="text-xs text-slate-500">Tên hiển thị</span>
              <input type="text" name="name" class="input-brand" required>
            </label>
            <label class="flex flex-col">
              <span class="text-xs text-slate-500">Mật khẩu</span>
              <input type="password" name="password" class="input-brand" required>
            </label>
            <label class="flex flex-col">
              <span class="text-xs text-slate-500">Vai trò</span>
              <select name="role" class="input-brand" required>
                <option value="admin">Quản trị viên</option>
                <option value="staff">Nhân viên</option>
              </select>
            </label>
          </form>
          <div class="flex gap-3">
            <button form="user-form" type="submit" class="btn-brand px-6 py-2.5">Thêm tài khoản</button>
            <button type="button" id="user-reset" class="px-6 py-2.5 rounded-xl border border-slate-300 text-slate-600">Xóa form</button>
          </div>
        </div>
      </section>

      <section class="card p-5">
        <div class="section-title mb-3">Danh sách người dùng</div>
        <div class="table-scroll">
          <table class="min-w-full text-sm">
            <thead class="table-brand">
              <tr>
                <th class="px-3 py-3 text-left">Tên đăng nhập</th>
                <th class="px-3 py-3 text-left">Tên hiển thị</th>
                <th class="px-3 py-3 text-left">Vai trò</th>
                <th class="px-3 py-3 text-right">Thao tác</th>
              </tr>
            </thead>
            <tbody id="system-user-table" class="divide-y" data-actions="true"></tbody>
          </table>
        </div>
      </section>

      <section class="card p-5 space-y-4" data-admin-only>
        <div class="section-title">Quản lý danh sách nhân viên</div>
        <p class="text-sm text-slate-500">Tùy chỉnh danh sách nhân viên xuất hiện trong các biểu mẫu chăm sóc khách hàng, checklist và các phân hệ khác.</p>
        <form id="staff-form" class="flex flex-col sm:flex-row gap-3">
          <input id="staff-input" class="input-brand flex-1" placeholder="Tên nhân viên mới" autocomplete="off">
          <button id="staff-add" class="btn-brand px-6 py-2.5">Thêm nhân viên</button>
        </form>
        <div id="staff-list" class="flex flex-wrap gap-2"></div>
      </section>

      <section class="card p-5 space-y-4" data-admin-only>
        <div class="section-title">Đồng bộ dữ liệu đa thiết bị</div>
        <p class="text-sm text-slate-500">Kết nối với máy chủ lưu trữ JSON (Google Apps Script, dịch vụ REST riêng, v.v.) <strong>hoặc</strong> đồng bộ trực tiếp với repository GitHub để các thiết bị cùng cập nhật chung một nguồn dữ liệu. Mặc định hệ thống sẽ tự khởi tạo một kho riêng trên <code>jsonstorage.net</code> và hiển thị đường dẫn bên dưới để bạn chia sẻ cho các thiết bị khác.</p>
        <form id="sync-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="inline-flex items-center gap-3 md:col-span-2 text-sm font-semibold text-slate-600">
            <input type="checkbox" name="enabled" class="h-5 w-5" data-sync-field>
            <span>Bật đồng bộ đám mây</span>
          </label>
          <label class="flex flex-col md:col-span-2">
            <span class="text-xs text-slate-500">Nền tảng đồng bộ</span>
            <select name="provider" class="input-brand" data-sync-field>
              <option value="jsonstorage">Máy chủ JSON (REST API)</option>
              <option value="github">GitHub Repository</option>
            </select>
          </label>
          <label class="flex flex-col md:col-span-2">
            <span class="text-xs text-slate-500">Chu kỳ kiểm tra (giây)</span>
            <input type="number" name="pollInterval" class="input-brand" min="5" step="1" data-sync-field>
          </label>
          <div id="sync-jsonstorage-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:col-span-2">
            <label class="flex flex-col md:col-span-2">
              <span class="text-xs text-slate-500">Địa chỉ máy chủ (GET/PUT JSON)</span>
              <input type="url" name="endpoint" class="input-brand" placeholder="https://example.com/klc.json" data-sync-field>
            </label>
            <label class="flex flex-col">
              <span class="text-xs text-slate-500">Phương thức ghi dữ liệu</span>
              <select name="method" class="input-brand" data-sync-field>
                <option value="PUT">PUT</option>
                <option value="POST">POST</option>
                <option value="PATCH">PATCH</option>
              </select>
            </label>
            <label class="flex flex-col">
              <span class="text-xs text-slate-500">Kiểu xác thực</span>
              <select name="authScheme" class="input-brand" data-sync-field>
                <option value="Bearer">Bearer token</option>
                <option value="Basic">Basic</option>
                <option value="Api-Key">API Key</option>
                <option value="None">Không dùng (tự cấu hình)</option>
              </select>
            </label>
            <label class="flex flex-col">
              <span class="text-xs text-slate-500">Mã truy cập / API key (tuỳ chọn)</span>
              <input type="text" name="apiKey" class="input-brand" placeholder="Nhập token" data-sync-field>
            </label>
            <label class="flex flex-col md:col-span-2">
              <span class="text-xs text-slate-500">Header bổ sung (mỗi dòng dạng Tên: Giá trị)</span>
              <textarea name="headers" class="input-brand" rows="3" placeholder="X-Custom-Header: Value" data-sync-field></textarea>
            </label>
          </div>
          <div id="sync-github-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:col-span-2 hidden">
            <label class="flex flex-col">
              <span class="text-xs text-slate-500">Chủ sở hữu (owner)</span>
              <input type="text" name="githubOwner" class="input-brand" placeholder="ten-to-chuc" data-sync-field>
            </label>
            <label class="flex flex-col">
              <span class="text-xs text-slate-500">Repository</span>
              <input type="text" name="githubRepo" class="input-brand" placeholder="klc-portal" data-sync-field>
            </label>
            <label class="flex flex-col">
              <span class="text-xs text-slate-500">Nhánh (branch)</span>
              <input type="text" name="githubBranch" class="input-brand" placeholder="main" data-sync-field>
            </label>
            <label class="flex flex-col">
              <span class="text-xs text-slate-500">Đường dẫn tệp dữ liệu</span>
              <input type="text" name="githubPath" class="input-brand" placeholder="data/klc-database.json" data-sync-field>
            </label>
            <label class="flex flex-col md:col-span-2">
              <span class="text-xs text-slate-500">GitHub Personal Access Token (chỉ đọc/ghi repository)</span>
              <input type="password" name="githubToken" class="input-brand" placeholder="ghp_..." data-sync-field autocomplete="off">
            </label>
            <p class="text-xs text-slate-500 md:col-span-2">Token cần quyền <code>repo</code> (hoặc <code>public_repo</code> với repository công khai). Hệ thống có thể tự tạo nhánh nếu chưa tồn tại.</p>
          </div>
        </form>
        <div class="flex flex-wrap items-center gap-3">
          <button id="sync-save" type="button" class="btn-brand px-6 py-2.5">Lưu cấu hình</button>
          <button id="sync-test" type="button" class="px-6 py-2.5 rounded-xl border border-brand-blue text-brand-blue">Kiểm tra kết nối</button>
          <button id="sync-now" type="button" class="px-6 py-2.5 rounded-xl border border-slate-300 text-slate-600">Đồng bộ ngay</button>
        </div>
        <div class="space-y-2">
          <div class="text-xs font-semibold text-slate-600">Đường dẫn đồng bộ hiện tại</div>
          <div class="flex flex-col sm:flex-row gap-2">
            <input id="sync-endpoint-display" class="input-brand flex-1 bg-slate-100" readonly>
            <button id="sync-copy" type="button" class="px-4 py-2.5 rounded-xl border border-brand-blue text-brand-blue">Sao chép</button>
          </div>
          <p class="text-xs text-slate-500">Sao chép đường dẫn này và cấu hình giống nhau trên thiết bị khác để mọi dữ liệu luôn đồng bộ.</p>
        </div>
        <div class="bg-slate-100 border border-slate-200 rounded-xl p-4 space-y-2 text-sm">
          <div>Trạng thái: <span id="sync-status-label" class="badge badge-warning">Đang tắt</span></div>
          <div>Lần đẩy dữ liệu gần nhất: <span id="sync-last-push">Chưa có</span></div>
          <div>Lần tải dữ liệu gần nhất: <span id="sync-last-pull">Chưa có</span></div>
          <div id="sync-error" class="text-rose-600 hidden">Không thể kết nối máy chủ.</div>
          <p class="text-xs text-slate-500 pt-2 border-t border-dashed">Máy chủ cần hỗ trợ GET để đọc và PUT/POST/PATCH để lưu toàn bộ nội dung JSON của hệ thống.</p>
        </div>
      </section>

      <section class="card p-5 space-y-4" data-admin-only>
        <div class="section-title">Nhận diện thương hiệu & logo</div>
        <p class="text-sm text-slate-500">Cập nhật tiêu đề, khẩu hiệu, logo chuẩn thương hiệu KLC và màu sắc chủ đạo cho toàn bộ cổng nội bộ.</p>
        <form id="branding-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="flex flex-col">
            <span class="text-xs text-slate-500">Tiêu đề hiển thị</span>
            <input type="text" name="title" class="input-brand" placeholder="KLC Bến Lức">
          </label>
          <label class="flex flex-col">
            <span class="text-xs text-slate-500">Khẩu hiệu / mô tả ngắn</span>
            <input type="text" name="tagline" class="input-brand" placeholder="Cổng nội bộ">
          </label>
          <label class="flex flex-col">
            <span class="text-xs text-slate-500">Đường dẫn logo (tùy chọn)</span>
            <input type="url" name="logoUrl" class="input-brand" placeholder="https://...">
          </label>
          <label class="flex flex-col">
            <span class="text-xs text-slate-500">Tải logo mới</span>
            <input type="file" id="branding-upload" accept="image/*" class="input-brand">
          </label>
          <label class="flex flex-col">
            <span class="text-xs text-slate-500">Màu chủ đạo</span>
            <input type="color" name="accent" class="input-brand h-12" value="#0b7c82">
          </label>
        </form>
        <div class="flex items-center gap-4">
          <img id="branding-preview" src="assets/img/logo-klc.svg" alt="Xem trước logo">
          <div class="text-sm text-slate-500">
            <div><span class="font-semibold">Tiêu đề:</span> <span id="branding-preview-title"></span></div>
            <div><span class="font-semibold">Khẩu hiệu:</span> <span id="branding-preview-tagline"></span></div>
          </div>
        </div>
        <div class="flex gap-3">
          <button id="branding-save" class="btn-brand px-6 py-2.5">Lưu nhận diện</button>
          <button id="branding-reset" type="button" class="px-6 py-2.5 rounded-xl border border-slate-300 text-slate-600">Khôi phục mặc định</button>
        </div>
      </section>

      <section class="card p-5 space-y-5" data-admin-only>
        <div>
          <div class="section-title">Trình chỉnh sửa bố cục</div>
          <p class="text-sm text-slate-500">Kéo thả để sắp xếp lại bố cục, thêm lối tắt, logo, khối HTML tuỳ chỉnh hoặc biểu đồ. Tất cả thay đổi được lưu và áp dụng ngay cho toàn bộ người dùng.</p>
        </div>
        <div id="layout-builder" class="builder-grid">
          <div>
            <h3 class="text-sm font-semibold text-brand-blue mb-3">Thư viện khối</h3>
            <div id="builder-palette" class="builder-palette"></div>
          </div>
          <div class="space-y-3 md:col-span-1">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <h3 class="text-sm font-semibold text-brand-blue">Bố cục trang tổng quan</h3>
              <div class="builder-item-actions">
                <button id="builder-save" class="btn-brand px-4 py-2">Lưu bố cục</button>
                <button id="builder-reset" class="px-4 py-2 rounded-xl border border-slate-300 text-slate-600" type="button">Khôi phục mặc định</button>
              </div>
            </div>
            <div id="builder-canvas" class="builder-canvas">
              <div class="builder-placeholder">Kéo thả khối từ thư viện ở bên trái để bổ sung vào trang.</div>
            </div>
          </div>
        </div>
      </section>

      <section class="card p-5 space-y-4" data-admin-only>
        <div class="section-title">Yêu cầu xóa dữ liệu</div>
        <p class="text-sm text-slate-500">Kiểm duyệt các yêu cầu xóa đến từ nhân viên. Phê duyệt để xóa vĩnh viễn hoặc từ chối nếu cần giữ lại dữ liệu.</p>
        <div class="table-scroll">
          <table class="min-w-full text-sm">
            <thead class="table-brand">
              <tr>
                <th class="px-3 py-3 text-left">Thời gian</th>
                <th class="px-3 py-3 text-left">Hạng mục</th>
                <th class="px-3 py-3 text-left">Người yêu cầu</th>
                <th class="px-3 py-3 text-left">Lý do</th>
                <th class="px-3 py-3 text-left">Trạng thái</th>
                <th class="px-3 py-3 text-right">Thao tác</th>
              </tr>
            </thead>
            <tbody id="deletion-requests-body" class="divide-y"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>
</div>

<script type="module" src="js/system.js"></script>
</body>
</html>
