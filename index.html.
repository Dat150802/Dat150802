<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KLC Nội bộ • Đăng nhập</title>

  <!-- UI tối thiểu -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body { background:#f7f9fc; }
    .card { max-width: 520px; margin: 8vh auto; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .muted { color:#6c757d; }
  </style>
</head>
<body>
  <div class="card p-4">
    <h4 class="mb-3">KLC Nội bộ</h4>

    <div id="signedOut">
      <p class="muted">Đăng nhập Google để tiếp tục</p>
      <div id="gbtnWrap" class="mb-2"></div>
      <div id="debug" class="small text-danger"></div>
      <div class="small text-muted">
        * Trang chạy trên GitHub Pages: <code>https://dat150802.github.io</code>
      </div>
    </div>

    <div id="signedIn" class="d-none">
      <div class="alert alert-success mb-3" id="meBox"></div>
      <button class="btn btn-outline-secondary" id="btnSignOut">Đăng xuất</button>
    </div>
  </div>

<script>
/* ======= CONFIG (đÃ gắn sẵn của bạn) ======= */
const CLIENT_ID  = "229964671691-jvq8pstlajqa9v6g0rhfi0u8ei39453u.apps.googleusercontent.com";
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxscUm2o0q70dsQm3mERQyyZWejd2TmQREfqXZ6qkbQtQYx-OWuB5BDFmBpBJj6_ebw/exec";

/* ======= GLOBAL ======= */
let ID_TOKEN = "";

/* ======= HELPERS ======= */
function showSignedIn(me){
  document.getElementById('signedOut').classList.add('d-none');
  document.getElementById('signedIn').classList.remove('d-none');
  document.getElementById('meBox').innerHTML =
    `<b>Đăng nhập thành công</b><br>Email: <code>${me.email}</code> • Quyền: <b>${me.role||'staff'}</b>`;
}
function showSignedOut(){
  document.getElementById('signedIn').classList.add('d-none');
  document.getElementById('signedOut').classList.remove('d-none');
}
function dlog(m){
  const e=document.getElementById('debug'); if(e) e.textContent=m;
  console.error(m);
}

/* ======= INIT (GIS) ======= */
window.onload = function(){
  try{
    if (!window.google || !google.accounts || !google.accounts.id){
      dlog('Không tải được Google Sign-In. Kiểm tra mạng/extension chặn script.');
      return;
    }
    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: onCredentialResponse,
      auto_select: false,
      ux_mode: 'popup' // Popup phù hợp cho GitHub Pages
    });
    google.accounts.id.renderButton(
      document.getElementById("gbtnWrap"),
      { theme: "outline", size: "large", width: 260 }
    );
  }catch(e){ dlog('Lỗi init GIS: ' + e); }
};

function onCredentialResponse(resp){
  ID_TOKEN = resp?.credential || "";
  if (!ID_TOKEN){ dlog('Không nhận được ID token.'); return; }
  postLogin();
}

/* ======= GỌI BACKEND (Apps Script Web App) ======= */
/* Dùng Content-Type: text/plain để tránh preflight CORS trên Web App */
async function callApi(action, payload){
  const body = JSON.stringify({ action, payload, idToken: ID_TOKEN });
  const res  = await fetch(WEBAPP_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body
  });
  return res.json();
}

async function postLogin(){
  try{
    const r = await callApi("me", {});
    if (r && r.ok){
      showSignedIn(r.data || {});
    }else{
      showSignedOut();
      alert("Đăng nhập thất bại: " + (r?.error || "UNKNOWN"));
    }
  }catch(err){
    showSignedOut();
    alert("Lỗi kết nối: " + err);
  }
}

document.getElementById('btnSignOut').onclick = () => {
  ID_TOKEN = "";
  showSignedOut();
};
</script>
</body>
</html>
