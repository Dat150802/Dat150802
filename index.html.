<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KLC Nội bộ</title>

  <!-- UI tối thiểu, bạn có thể giữ giao diện cũ của mình -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-light">
<div class="container py-4">
  <h3 class="mb-3">KLC Nội bộ</h3>

  <div id="signedOut" class="card p-3">
    <h5>Đăng nhập Google để tiếp tục</h5>
    <div id="gbtn" class="my-2"></div>
    <div id="debug" class="text-danger small"></div>
    <p class="text-muted small mb-0">Chỉ tài khoản có trong sheet <code>users</code> (status=active) mới truy cập.</p>
  </div>

  <div id="app" class="card p-3 d-none">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Bạn đã đăng nhập</h5>
      <span id="meBox" class="text-muted small"></span>
    </div>
    <hr>
    <div class="d-grid gap-2 d-sm-flex">
      <button class="btn btn-primary" onclick="demoDashboard()">Gọi API: dashboard</button>
      <button class="btn btn-outline-secondary" onclick="logout()">Đăng xuất</button>
    </div>
    <pre id="out" class="mt-3 small"></pre>
  </div>
</div>

<script>
/*** ======= CẦN THAY ======= ***/
const CLIENT_ID  = "PASTE_YOUR_CLIENT_ID.apps.googleusercontent.com"; // <-- dán Client ID OAuth của bạn
const WEBAPP_URL = "https://script.google.com/macros/s/PASTE_YOUR_DEPLOYED_EXEC_URL/exec"; // <-- dán URL web-app (exec)

/*** ======= BIẾN TOÀN CỤC ======= ***/
let ID_TOKEN = "";     // nhận từ GIS
let ME = null;         // thông tin user trả về từ backend

function dlog(s){ const e=document.getElementById('debug'); if(e) e.textContent=s; console.error(s); }
function show(id, yes){ document.getElementById(id).classList.toggle('d-none', !yes); }
function out(obj){ document.getElementById('out').textContent = typeof obj==='string' ? obj : JSON.stringify(obj,null,2); }

/*** ======= KHỞI TẠO ĐĂNG NHẬP (GIS) ======= ***/
window.onload = function(){
  try{
    if (!window.google || !google.accounts || !google.accounts.id){ dlog('Không tải được Google Sign-In.'); return; }
    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: onCredentialResponse,
      ux_mode: 'popup'
      // GitHub Pages không cần allowed_parent_origin
    });
    google.accounts.id.renderButton(
      document.getElementById('gbtn'),
      { theme:'outline', size:'large', width: 260 }
    );
  }catch(e){ dlog('Lỗi init GIS: '+e); }
};

function onCredentialResponse(resp){
  ID_TOKEN = resp.credential || "";
  postLogin();
}

/*** ======= GỌI BACKEND (Apps Script) BẰNG fetch ======= ***/
async function callApi(action, payload){
  const res = await fetch(WEBAPP_URL, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({action, payload, idToken: ID_TOKEN})
  });
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || 'API_ERROR');
  return json.data;
}

/*** ======= HẬU ĐĂNG NHẬP ======= ***/
async function postLogin(){
  try{
    const me = await callApi('me', {});
    ME = me;
    show('signedOut', false);
    show('app', true);
    document.getElementById('meBox').textContent = `${me.email} (${me.role})`;
    out(me);
  }catch(err){
    dlog('Không có quyền hoặc token lỗi: '+ err.message);
    alert("Không có quyền hoặc tài khoản chưa được cấp ('users').");
  }
}

function logout(){
  ID_TOKEN = ""; ME = null;
  show('app', false);
  show('signedOut', true);
  document.getElementById('out').textContent = '';
  dlog('');
}

/*** ======= DEMO GỌI API ======= ***/
async function demoDashboard(){
  try{
    const data = await callApi('dashboard', {month: new Date().getMonth()+1});
    out(data);
  }catch(e){ out('Lỗi: '+e.message); }
}
</script>
</body>
</html>
